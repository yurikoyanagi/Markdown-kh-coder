---
title: 解析プロトコル
author: 柳百合子，髙岡昂太
date: "`r Sys.Date()`"
output: html_document
---
# Rstudio 解析コード
### **1. 環境構築としてのコード**

```{r 環境構築としてのコード}
options(repos = list(CRAN="http://cran.rstudio.com/"))
install.packages("magrittr")
install.packages("ggdendro")
install.packages("amap")
install.packages("wordcloud")
```
### **2. 共起ネットワーク分析:小学生女児(図1と対応）**
```{r 共起ネットワーク分析（小学生女児）}

d <- NULL
d <- matrix( c(2,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,4,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,6,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,7,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,9,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2
,11,0,1,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,13,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,15,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,17,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,19,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0
,20,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,22,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,24,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,26,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,28,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,30,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,32,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,34,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0
,36,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,0,0
,37,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0
,39,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,2,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0
,41,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0
,43,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,45,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,47,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0
,49,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0
,51,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,53,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0
,54,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0
,56,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,58,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0
,60,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0
,62,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,64,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1
,66,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,68,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,70,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,72,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,74,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,76,0,2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,78,0,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,80,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0
,82,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,84,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,86,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0
,88,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,90,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,92,0,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,94,2,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0
,96,0,0,0,0,0,0,1,0,0,1,1,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0
,98,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,2,0,0,0,0,0,0,0
,100,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0
,102,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,104,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,106,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0
,110,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,112,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0
,114,0,1,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,2,0,0,0,0,0
,116,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,118,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,120,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,122,2,1,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,1,0,0,0,0,0
,124,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0
,125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,127,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,129,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,131,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0
,133,0,1,1,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,135,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,139,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,140,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0
,142,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,1,0,0,0,0,0,0,0
,144,0,2,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0
,146,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,148,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0
,150,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0
,152,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,154,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,156,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,158,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,160,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,162,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,2,0,0,0
,164,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,166,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,168,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0
,170,1,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,172,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,174,2,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,2,0,0,0,0,0,0,0
,176,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,178,1,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,180,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,181,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,183,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,185,1,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,187,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,189,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,191,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,193,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,195,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0
,197,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,198,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,200,2,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,202,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,204,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,205,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,207,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,209,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,210,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,212,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0
,214,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0
,216,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,218,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,220,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0
,222,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0
,224,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0
,226,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,228,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,230,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,1,0,0,0,0,0,0
,232,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,234,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0
,236,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0
,238,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,240,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,242,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,2,0,0,0,0
,243,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,245,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,247,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,249,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,251,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0
,252,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,253,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,257,0,1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,259,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,261,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0
,263,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,265,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0
,267,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,269,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,271,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,273,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,275,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0
,277,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,279,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,281,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,283,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,285,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,287,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0
,289,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,291,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,293,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,295,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,297,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0
,299,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0
,300,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,302,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,304,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,306,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,308,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,310,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,312,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,314,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,315,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,317,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0), byrow=T, nrow=166, ncol=64 )
d <- d[,-1]
colnames(d) <- c("\u6bcd\u89aa","\u88ab\u5bb3","\u6559\u54e1","\u5b66\u6821","\u30bb\u30f3\u30bf\u30fc","\u53cb\u4eba","\u8b66\u5bdf","\u8a34\u3048","\u75c5\u9662","\u990a\u7236","\u52a0\u5bb3","\u7956\u6bcd","\u5bb6\u65cf","\u5bb6\u5ead","\u6a5f\u95a2","\u5fc3\u7406","\u5bfe\u8c61","\u77e5\u4eba","\u5225\u4ef6","\u30af\u30e9\u30d6","\u533b\u5e2b","\u5e02\u5f79\u6240","\u81ea\u8eab","\u5834\u9762","\u60c5\u5831","\u7537\u5150","\u6bcd\u65b9","\u69d8\u5b50","\u76f8\u8ac7","\u767a\u898b","\u901a\u544a","\u958b\u793a","\u652f\u63f4","\u8650\u5f85","\u65bd\u8a2d","\u9762\u63a5","\u8a71","\u6559\u80b2","\u53d7\u8a3a","\u76ee\u6483","\u95a2\u4fc2","\u902e\u6355","\u5165\u9662","\u767a\u8a00","\u6027\u7684","\u990a\u8b77\u6559\u8aed","\u4e00\u6642\u4fdd\u8b77","\u5150\u76f8","\u8a9e\u308b","\u53d7\u3051\u308b","\u8a34\u3048\u308b","\u805e\u304f","\u805e\u304d\u53d6\u308b","\u898b\u308b","\u6253\u3061\u660e\u3051\u308b","\u5150","\u5e02","\u6027","\u59c9","\u7236","\u5144","\u89aa","\u59b9")
doc_length_mtr <- matrix( c( 11,7,11,7,7,4,6,4,20,15,16,10,15,10,16,5,28,17,23,18,10,6,13,9,44,30,16,10,11,7,11,6,16,10,10,6,42,28,13,7,37,23,24,15,26,15,22,14,17,12,25,16,8,5,15,12,19,13,18,12,30,17,25,19,24,17,24,18,28,19,7,4,23,14,28,19,22,15,19,12,21,13,9,6,21,14,22,13,16,11,19,11,15,8,15,9,46,29,44,27,44,32,38,27,52,34,12,8,20,11,12,6,16,10,16,9,56,34,14,8,23,16,13,10,84,57,15,11,14,8,25,13,5,3,18,13,28,19,9,6,9,5,8,6,14,10,21,14,50,30,11,7,37,22,44,25,8,6,20,10,13,8,22,16,6,5,19,15,16,10,10,6,19,13,24,13,14,9,26,14,19,16,24,13,13,9,21,12,43,28,13,9,10,7,8,5,27,20,7,3,30,21,16,10,17,11,29,21,19,12,9,6,13,7,7,4,9,6,11,8,37,27,13,9,23,15,4,3,10,6,11,7,11,6,9,5,8,5,18,12,10,7,26,16,27,19,14,8,2,1,19,15,9,6,17,12,8,6,46,27,11,6,1,1,14,11,22,14,18,11,8,5,14,8,11,6,23,13,21,13,7,4,25,16,20,13,19,13,5,3,40,27,8,4,24,12,12,7,23,12,10,6,7,3,2,1,10,6,24,16,28,12,8,4,33,21,14,8,16,10,10,6,7,5,16,9,10,7,9,6,16,11), ncol=2, byrow=T)
colnames(doc_length_mtr) <- c("length_c", "length_w")
color_universal_design <- 1

d <- t(d)
# END: DATA
edges <- 100
th <- -1
font_size <- 1
margin_top <- 0
margin_bottom <- 0
margin_left <- 0
margin_right <- 0
view_coef <- 0
fix_lab <- 1
use_freq_as_size <- 1
bubble_size <- 100
use_weight_as_width <- 1
smaller_nodes <- 0
text_font <- 1
min_sp_tree <- 0
min_sp_tree_only <- 0
cor_var <- 0
cor_var_darker <- 0
cor_var_min <- -1
cor_var_max <- 1
use_alpha <- 1
gray_scale <- 0
method_coef <- "binary"

standardize_coef <- 1
breaks <- NULL
# additional_plots: 0

com_method <- "com-g"


# Count frequency of each word
freq <- NULL
for (i in 1:length( rownames(d) )) {
	freq[i] = sum( d[i,] )
}

# Compute co-occurrence coefficient
if ( (exists("doc_length_mtr")) &! (method_coef == "binary")){
	leng <- as.numeric(doc_length_mtr[,2])
	leng[leng ==0] <- 1
	d <- t(d)
	d <- d / leng
	d <- d * 1000
	d <- t(d)
}
if (method_coef == "euclid"){ # standardize for each word
	d <- t( scale( t(d) ) )
}

dr <- d
library(amap)
d <- Dist(d,method=method_coef)

d <- as.matrix(d)
if ( method_coef == "euclid" ){
	d <- max(d) - d
	d <- d / max(d)
} else {
	d <- 1 - d
}

# For twomode
if ( exists("com_method") ){
	if ( com_method == "twomode_c" || com_method == "twomode_g" ){
		# delete unnecessary edges
		d[1:n_words,] <- 0

		# standardize coef.
		if ( standardize_coef == 1 ) {
			std  <- d[(n_words+1):nrow(d),1:n_words]
			chkm <- std
			
			std <- t(std)
			std <- scale(std, center=T, scale=F)
			std <- t(std)
	
			chkm_temp <- chkm[!is.na(chkm)]
			std_range <- max(chkm_temp) - min(chkm_temp[chkm_temp!=0])
			std <- std - min(std[!is.na(std)])        # min = 0
			std <- std / max(std[!is.na(std)])        # max = 1
			std <- std * std_range                    # set range
			std <- std + min(chkm_temp[chkm_temp!=0]) # set min
			chkm_temp <- NULL
			
			std[chkm == 0] <- 0
			d[(n_words+1):nrow(d),1:n_words] <- std
		}
	}
}

# Make a graph
# For igraph > 1.0.0
library(igraph)
new_igraph <- 0
igraph_ver <- (
	  as.numeric( substr(sessionInfo()$otherPkgs$igraph$Version, 1,1) ) * 10
	+ as.numeric( substr(sessionInfo()$otherPkgs$igraph$Version, 3,3) )
)
if ( igraph_ver > 5){
	new_igraph <- 1
}

n <- graph.adjacency(d, mode="lower", weighted=T, diag=F)
n <- igraph::set.vertex.attribute(
	n,
	"name",
	(0+new_igraph):(length(d[1,])-1+new_igraph),
	as.character( 1:length(d[1,]) )
)

# Prepare for deleting weak edges
el <- data.frame(
	edge1            = get.edgelist(n,name=T)[,1],
	edge2            = get.edgelist(n,name=T)[,2],
	weight           = igraph::get.edge.attribute(n, "weight"),
	stringsAsFactors = FALSE
)

# making backup of coef.
if ( exists("com_method") ){
	if (
		( com_method == "twomode_c" || com_method == "twomode_g" )
		&& ( standardize_coef == 1 )
	){
		dbb <- d
		dbb[(n_words+1):nrow(dbb),1:n_words] <- chkm
		
		nbb <- graph.adjacency(dbb, mode="lower", weighted=T, diag=F)
		nbb <- igraph::set.vertex.attribute(
			nbb,
			"name",
			(0+new_igraph):(length(dbb[1,])-1+new_igraph),
			as.character( 1:length(dbb[1,]) )
		)
		
		elbb <- data.frame(
			edge1            = get.edgelist(nbb,name=T)[,1],
			edge2            = get.edgelist(nbb,name=T)[,2],
			weight_b           = igraph::get.edge.attribute(nbb, "weight"),
			stringsAsFactors = FALSE
		)
		
		if ( identical(el[,1:2], elbb[,1:2]) == F ){
			print("Error: could not make coef. backup!")
		}
		
		el <- data.frame(el, elbb$weight_b)
	}
}

# Find a threshold value
if (th < 0){
	if(edges > length(el[,1])){
		edges <- length(el[,1])
	}
	th = quantile(
		el$weight,
		names = F,
		probs = 1 - edges / length(el[,1])
	)
}

# Delete weak edges and make a graph again
el2 <- subset(el, el[,3] >= th)
if ( nrow(el2) == 0 ){
	stop(message = "No edges to draw!", call. = F)
}
n2  <- graph.edgelist(
	matrix( as.matrix(el2)[,1:2], ncol=2 ),
	directed	=F
)
n2 <- igraph::set.edge.attribute(
	n2,
	"weight",
	(0+new_igraph):(length(get.edgelist(n2)[,1])-1+new_igraph),
	el2[,3]
)

# use the backup of coef.
if ( exists("com_method") ){
	if (
		( com_method == "twomode_c" || com_method == "twomode_g" )
		&& ( standardize_coef == 1 )
	){
		n2 <- igraph::set.edge.attribute(
			n2,
			"weight",
			(0+new_igraph):(length(get.edgelist(n2)[,1])-1+new_igraph),
			el2[,4]
		)
	}
}

if ( min_sp_tree_only == 1 ){
	n2 <- minimum.spanning.tree(
		n2,
		weights = 1 - igraph::get.edge.attribute(n2, "weight"),
		algorithm="prim"
	)
}


if (length(igraph::get.vertex.attribute(n2,"name")) < 2){
	com_method <- "none"
}

# Centrality
if ( com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e"){
	ccol <- NULL
	if (com_method == "cnt-b"){                   # betweenness
		ccol <- igraph::betweenness(
			n2,
			v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph),
			directed=F
		)
	}
	if (com_method == "cnt-d"){                   # degree
		ccol <-  igraph::degree(
			n2,
			v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph)
		)
	}
	if (com_method == "cnt-e"){                   # evcent
		try(
			ccol <- igraph::evcent(n2)$vector,
			silent = T
		)
	}
	ccol_raw <- ccol

	edg_col   <- "gray55"
	edg_lty   <- 1
}

# Community detection
if (com_method == "com-b" || com_method == "com-g" || com_method == "com-r"){
	merge_step <- function(n2, m){                # \u5171\u901a\u5229\u7528\u306e\u95a2\u6570
		for ( i in 1:( trunc( length( m ) / 2 ) ) ){
			temp_csize <- community.to.membership(n2, m,i)$csize
			num_max   <- max( temp_csize )
			num_alone <- sum( temp_csize[ temp_csize == 1 ] )
			num_cls   <- length( temp_csize[temp_csize > 1] )
			#print( paste(i, "a", num_alone, "max", num_max, "cls", num_cls) )
			if (
				# \u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u5168\u30ce\u30fc\u30c9\u6570\u306e22.5%\u4ee5\u4e0a
				   num_max / length(igraph::get.vertex.attribute(n2,"name")) >= 0.225
				# \u304b\u3064\u3001\u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u5358\u72ec\u30ce\u30fc\u30c9\u6570\u3088\u308a\u3082\u5927\u304d\u3044
				&& num_max > num_alone
				# \u304b\u3064\u3001\u30b5\u30a4\u30ba\u304c2\u4ee5\u4e0a\u306e\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u6570\u304c12\u672a\u6e80
				&& num_cls < 12
			){
				return(i)
			}
			# \u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u30ce\u30fc\u30c9\u6570\u306e40%\u3092\u8d8a\u3048\u308b\u76f4\u524d\u3067\u6253\u3061\u5207\u308a
			if (num_max / length(igraph::get.vertex.attribute(n2,"name")) >= 0.4 ){
				return(i-1)
			}
		}
		return( trunc(length( m ) / 2) )
	}
	# For igraph > 1.0.0
	if (com_method == "com-b"){                   # Betweenness
		com   <- edge.betweenness.community(n2, directed=F)    
		if (igraph_ver < 10){
			com_m <- community.to.membership(
				n2, com$merges, merge_step(n2,com$merges)
			)
			com_m$membership <- com_m$membership + new_igraph
		}
	}
	if (com_method == "com-g"){                   # Modularity
		com   <- fastgreedy.community   (n2, merges=TRUE, modularity=TRUE)
		if (igraph_ver < 10){
			com_m <- community.to.membership(
				n2, com$merges, merge_step(n2,com$merges)
			)
			com_m$membership <- com_m$membership + new_igraph
		}
	}
	if (com_method == "com-r"){                   # Random walks
		com   <-  walktrap.community(
			n2,
			weights=igraph::get.edge.attribute(n2, "weight")
		)
		if (igraph_ver < 10){
			com_m <- NULL
			com_m$membership <- com$membership
			com_m$csize      <- table(com$membership)
		}
	}
	if (igraph_ver >= 10){
		com_m <- NULL
		com_m$membership <- as.vector( membership(com) )
		com_m$csize      <- table(com_m$membership)
	}

	# Configure Edges
	edg_lty <- NULL
	edg_col <- NULL
	for (i in 1:nrow(get.edgelist(n2,name=F))){
		if (
			   com_m$membership[ get.edgelist(n2,name=F)[i,1] + 1 - new_igraph]
			== com_m$membership[ get.edgelist(n2,name=F)[i,2] + 1 - new_igraph]
		){
			edg_col <- c( edg_col, "gray55" )
			edg_lty <- c( edg_lty, 1 )
		} else {
			edg_col <- c( edg_col, "gray" )
			edg_lty <- c( edg_lty, 3 )
		}
	}
}

# \u5909\u6570\u30fb\u898b\u51fa\u3057\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306e\u30ab\u30e9\u30fc
if (com_method == "twomode_c" || com_method == "twomode_g"){
	if ( exists("var_select") ){
		var_select_bak <- var_select
	}
	
	var_select <- substring(
		colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ],
		1,
		2
	) == "<>"

	if (length(var_select[var_select==TRUE]) == 0 && exists("var_select_bak")){
		var_select <- var_select_bak;
	}
}

if (com_method == "twomode_c"){
	ccol <-  igraph::degree(
		n2,
		v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph)
	)
	# ggplot2
	ccol_raw <- ccol
	ccol_raw[var_select] <- NA
	ccol_raw[ccol_raw >= 5] <- 5
	ccol_raw <- as.character(ccol_raw)
	ccol_raw[ccol_raw=="5"] <- "5+"

	edg_col   <- "gray70"
	edg_lty   <- 1

}

# \u30ab\u30e9\u30fc\u30ea\u30f3\u30b0\u300c\u306a\u3057\u300d\u306e\u5834\u5408\u306e\u7dda\u306e\u8272\uff082010 12/4\uff09
if (com_method == "none" || com_method == "twomode_g"){
	edg_lty <- 1
	edg_col   <- "gray40"
}

if (com_method == "twomode_g"){
	edg_lty <- 3
}

# Minimum Spanning Tree
if ( min_sp_tree == 1 ){
	# MST\u306e\u691c\u51fa
	mst <- minimum.spanning.tree(
		n2,
		weights = 1 - igraph::get.edge.attribute(n2, "weight"),
		algorithm="prim"
	)

	# MST\u306b\u5408\u81f4\u3059\u308bedge\u3092\u5f37\u8abf
	#if (length(edg_col) == 1){
		edg_col <- rep("gray55", length( igraph::get.edge.attribute(n2, "weight") )) 
	#}

	n2_edges  <- get.edgelist(n2,name=T);
	mst_edges <- get.edgelist(mst,name=T);

	if (exists("edg_lty") == F){
		edg_lty <- 1
	}
	for ( i in 1:ecount(n2) ){
		name_n2 <- paste(
			n2_edges[i,1],
			n2_edges[i,2]
		)
		for ( j in 1:ecount(mst) ){
			name_mst <- paste(
				mst_edges[j,1],
				mst_edges[j,2]
			)
			if ( name_n2 == name_mst ){
				edg_col[i]   <- "gray30"                   # edge color
				if ( length(edg_lty) > 1 ){
					edg_lty[i] <- 1                        # edge linetype
				}
				break
			}
		}
	}
	edg_mst <- edg_col
}

# \u521d\u671f\u914d\u7f6e
lay <- NULL
if ( length(igraph::get.vertex.attribute(n2,"name")) >= 3 ){
	d4l <- as.dist( shortest.paths(n2) )
	if ( min(d4l) < 1 ){
		d4l <- as.dist( shortest.paths(n2, weights=NA ) )
	}
	if ( max(d4l) == Inf){
		d4l[d4l == Inf] <- vcount(n2)
	}
	try( lay <- cmdscale( d4l, k=2 ), silent=TRUE )
	if ( is.null(lay) == F ){
		lay <- round(lay, digits=5)
		check4fr <- function(d){
			chk <- 0
			for (i in combn( length(d[,1]), 2, simplify=F ) ){
				if (
					   d[i[1],1] == d[i[2],1]
					&& d[i[1],2] == d[i[2],2]
				){
					return( i[1] )
				}
			}
			return( NA )
		}
		salt <- 1
		while ( is.na(check4fr(lay)) == 0 ){
			mv <-  check4fr(lay)
			lay[mv,1] <- lay[mv,1] + 0.001 * salt
			# Much faster if you add salt. But layout will be changed.
			#salt <- salt + 0.2
			#print( paste( "Moved:", mv ) )
		}
	}
}

# \u914d\u7f6e
set.seed(100)
if (
	   (com_method == "twomode_c" || com_method == "twomode_g")
	&& ( igraph::is.connected(n2) )
){
	# For igraph > 1.0.0
	if (igraph_ver >= 10){
		lay_f <- layout.kamada.kawai(
			n2,
			#coords   = lay,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	} else {
		lay_f <- layout.kamada.kawai(
			n2,
			start   = lay,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	}
} else {
	# For igraph > 1.0.0
	if (igraph_ver >= 10){
		lay_f <- layout.fruchterman.reingold(
			n2,
			#coords   = lay,
			niter   = vcount(n2) * 512,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	} else {
		lay_f <- layout.fruchterman.reingold(
			n2,
			start   = lay,
			niter   = vcount(n2) * 512,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	}
}

lay_f <- scale(lay_f,center=T, scale=F)
for (i in 1:2){
	lay_f[,i] <- lay_f[,i] - min(lay_f[,i]); # \u6700\u5c0f\u30920\u306b
	lay_f[,i] <- lay_f[,i] / max(lay_f[,i]); # \u6700\u5927\u30921\u306b
	lay_f[,i] <- ( lay_f[,i] - 0.5 ) * 1.96;
}


# \u5916\u90e8\u5909\u6570\u30fb\u898b\u51fa\u3057\u3092\u4f7f\u3046\u5834\u5408\u306e\u5f62\u72b6\u3084\u30b5\u30a4\u30ba
if (com_method == "twomode_c" || com_method == "twomode_g"){
	# \u8b58\u5225\u7528\u306e\u300c<>\u300d\u3092\u5916\u3059
	colnames(d)[
		substring(colnames(d), 1, 2) == "<>"
	] <- substring(
		colnames(d)[
			substring(colnames(d), 1, 2) == "<>"
		],
		3,
		nchar(colnames(d)[
			substring(colnames(d), 1, 2) == "<>"
		],type="c")
	)
}


if ( exists("saving_emf") || exists("saving_eps") ){
	use_alpha <- 0           # need something before \n (gui_widget::r_net)
	use_weight_as_width <- 0 # need something before \n (gui_widget::r_net)
}

target_ids <-  NULL
if ( exists("target_words") ){
	# get word IDs
	for (i in 1:length( igraph::get.vertex.attribute(n2,"name") ) ){
		for (w in target_words){
			if (
				colnames(d)[ as.numeric(igraph::get.vertex.attribute(n2,"name")[i]) ]
				== w
			){
				target_ids <- c(target_ids, i)
			}
		}
	}
}

edge_label <- NULL

font_fam <- "Meiryo UI"
if ( exists("PERL_font_family") ){
	font_fam <- PERL_font_family
}

if ( length(igraph::get.vertex.attribute(n2,"name")) > 1 ){
	if (fix_lab == 1){
		if (exists("if_fixed") == 0){
			plot.new()
			plot.window(xlim=c(-1, 1), ylim=c(-1, 1))
			
			labcd <- NULL
			labcd$x <- lay_f[,1]
			labcd$y <- lay_f[,2]
			word_labs <- colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
	
			library(wordcloud)

# fix for "wordlayout" function
filename <- tempfile()
writeLines("wordlayout <- function (x, y, words, cex = 1, rotate90 = FALSE, xlim = c(-Inf, 
	Inf), ylim = c(-Inf, Inf), tstep = 0.1, rstep = 0.1, ...) 
{
	tails <- \"g|j|p|q|y\"
	n <- length(words)
	sdx <- sd(x, na.rm = TRUE)
	sdy <- sd(y, na.rm = TRUE)
	iterations <- 0
	if (sdx == 0) 
		sdx <- 1
	if (sdy == 0) 
		sdy <- 1
	if (length(cex) == 1) 
		cex <- rep(cex, n)
	if (length(rotate90) == 1) 
		rotate90 <- rep(rotate90, n)
	boxes <- list()
	for (i in 1:length(words)) {
		rotWord <- rotate90[i]
		r <- 0
		theta <- runif(1, 0, 2 * pi)
		x1 <- xo <- x[i]
		y1 <- yo <- y[i]
		wid <- strwidth(words[i], cex = cex[i], ...)
		ht <- strheight(words[i], cex = cex[i], ...)
		if (grepl(tails, words[i])) 
			ht <- ht + ht * 0.2
		if (rotWord) {
			tmp <- ht
			ht <- wid
			wid <- tmp
		}
		isOverlaped <- TRUE
		while (isOverlaped) {
			if (!.overlap(x1 - 0.5 * wid, y1 - 0.5 * ht, wid, 
				ht, boxes) && x1 - 0.5 * wid > xlim[1] && y1 - 
				0.5 * ht > ylim[1] && x1 + 0.5 * wid < xlim[2] && 
				y1 + 0.5 * ht < ylim[2]) {
				boxes[[length(boxes) + 1]] <- c(x1 - 0.5 * wid, 
				  y1 - 0.5 * ht, wid, ht)
				isOverlaped <- FALSE
			}
			else {
				theta <- theta + tstep
				r <- r + rstep * tstep/(2 * pi)
				x1 <- xo + sdx * r * cos(theta)
				y1 <- yo + sdy * r * sin(theta)
				iterations <- iterations + 1
				if (iterations > 500000){
					boxes[[length(boxes) + 1]] <- c(x1 - 0.5 * wid, 
				  y1 - 0.5 * ht, wid, ht)
					isOverlaped = FALSE
				}
			}
		}
	}
	print( paste(\"iterations: \", iterations) )
	result <- do.call(rbind, boxes)
	colnames(result) <- c(\"x\", \"y\", \"width\", \"ht\")
	rownames(result) <- words
	result
}
", filename)
if ( packageVersion("wordcloud") == 2.4){
	insertSource(filename, package="wordcloud", force=FALSE)
}
nc <- wordlayout(
				labcd$x,
				labcd$y,
				word_labs,
				cex=1.28,
				xlim=c( -1, 1 ),
				ylim=c( -1, 1 )
			)
	
			xorg <- labcd$x
			yorg <- labcd$y
			labcd$x <- nc[,1] + .5 * nc[,3]
			labcd$y <- nc[,2] + .5 * nc[,4]
			lay_f <- cbind(labcd$x, labcd$y)
	
			if_fixed <- 1
		}
	}

#-----------------------------------------------------------------------------#
#                       Prepare for Plotting with ggplot2                     #

#------------------------------------------------#
#  get ready for ggplot2 graph drawing (0): cor  #

if ( com_method == "cor" ){  # cor
	dr <- as.data.frame( t(dr) )
	dv <- data.frame(
	  khvar_ = as.numeric(v0)
	)
	dr <- cbind(dr,dv)

	edge_pos <- NULL
	edges <- get.edgelist(n2, names=TRUE)
	for (i in 1:nrow(edges)){
		i1 <- as.numeric( edges[i,1] )
		i2 <- as.numeric( edges[i,2] )
		
		edge_pos <- c(
			edge_pos,
			cor(
				as.numeric( dr[,i1] > 0 & dr[,i2] >0 ),
				dr$khvar_,
				method="pearson"
			)
			#mean( dr[dr[,i1] > 0 & dr[,i2] >0,]$khvar_ )
		)
	}

	if ( length( edge_pos[is.na(edge_pos) == F] ) == 0 ){
		edge_pos <- 0
	}

	#n2 <- igraph::set.edge.attribute(
	#	n2,
	#	"edge_pos_o",
	#	1:length(igraph::get.edge.attribute(n2,"weight")),
	#	edge_pos
	#)

	#edge_pos <- edge_pos - mean(edge_pos)
	#edge_pos <- edge_pos / sd(edge_pos)
	##edge_pos <- edge_pos * 10 + 50

	#limv <- 0.15
	#maxv <- max( abs( edge_pos ) )
	
	#if ( limv < maxv ){
	#	edge_pos[edge_pos > limv]  <- limv
	#	edge_pos[edge_pos < -limv] <- -limv
	#}

	edge_pos[edge_pos > cor_var_max] <- cor_var_max
	edge_pos[edge_pos < cor_var_min] <- cor_var_min
	
	n2 <- igraph::set.edge.attribute(
		n2,
		"edge_pos",
		1:length(igraph::get.edge.attribute(n2,"weight")),
		edge_pos
	)

	ver_pos <- NULL
	vertices <- as.numeric( igraph::get.vertex.attribute(n2,"name") )
	for (i in 1:length(vertices) ){
		ver_pos <- c(
			ver_pos,
			cor(
				as.numeric( dr[,vertices[i]] > 0 ),
				dr$khvar_,
				method="pearson"
			)
		)
	}

	if ( length( ver_pos[is.na(ver_pos) == F] ) == 0 ){
	  ver_pos <- 0
	}

	ver_pos[ver_pos > max(edge_pos)] <- max(edge_pos)
	ver_pos[ver_pos < min(edge_pos)] <- min(edge_pos)

	#n2 <- igraph::set.vertex.attribute(
	#	n2,
	#	"ver_pos",
	#	1:length(igraph::get.vertex.attribute(n2,"name")),
	#	ver_pos
	#)
	ccol_raw <- ver_pos
	if ( is.null( igraph::get.vertex.attribute(n2,"com") ) == FALSE ){
		n2 <- remove.vertex.attribute(n2, "com")
		edg_lty <- 1
	}
}

#-----------------------------------------------#
#  get ready for ggplot2 graph drawing (1): n2  #

n2 <- igraph::set.vertex.attribute(
	n2,
	"lab",
	1:length(igraph::get.vertex.attribute(n2,"name")),
	colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
)

ver_freq <- freq[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]

if (com_method == "twomode_c" || com_method == "twomode_g"){
	ver_freq[var_select] <- NA
}

if ( is.null(target_ids) == FALSE ){
	ver_freq[target_ids] <- NA
}

if (use_freq_as_size == 0){
	ver_freq[ver_freq > 0] <- 1
}

n2 <- igraph::set.vertex.attribute(
	n2,
	"size",
	1:length(igraph::get.vertex.attribute(n2,"name")),
	ver_freq
)

# For community detection

if ( exists("ccol") ){ # clean up previous data
	try( n2 <- remove.vertex.attribute(n2, "com"), silent=T )
}

if ( exists("com_m") ){
	com_label <- NULL

	for (h in 1:length(com_m$membership)){
		i <- com_m$membership[h]
		if ( com_m$csize[i] > 1 ) {
			if (i < 10){
				com_label <- c(
					com_label,
					paste("0", as.character(i), "   ", sep="")
				)
			} else {
				com_label <- c(com_label, as.character(i))
			}
		} else {
			com_label <- c(com_label, NA)
		}
	}

	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		com_label
	)
}

if ( exists("ccol_raw") ){
	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		ccol_raw
	)
	com_label <- ccol_raw
}

if ( com_method == "none" || com_method == "twomode_g"){
	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		rep( "na", length(igraph::get.vertex.attribute(n2,"name")) )
	)
	com_label <- NA
}

if ( exists("edg_mst") ){
	n2 <- igraph::set.edge.attribute(
		n2,
		"edg_col",
		1:length(igraph::get.edge.attribute(n2,"weight")),
		edg_mst
	)
	#print(edg_mst)
}

if ( exists("edg_lty") == F ){
	edg_lty <- 1
}
edg_lty[edg_lty==1] <- "solid"
edg_lty[edg_lty==3] <- "dotted"

n2 <- igraph::set.edge.attribute(
	n2,
	"line",
	1:length(igraph::get.edge.attribute(n2,"weight")),
	edg_lty
)

#-------------------------------------------------------#
#  get ready for ggplot2 graph drawing (2): parameters  #

library(ggplot2)
library(ggnetwork)

p <- ggplot(
	ggnetwork(n2, layout=lay_f),
	aes(x = x, y = y, xend = xend, yend = yend),
)

if (use_alpha == 1){
	alpha_value = 0.62
	gray_color_n <- "gray20"
} else {
	alpha_value = 1
	gray_color_n <- "gray40"

}

if (text_font == 2){
	face <- "bold"
} else {
	face <- "plain"
}
if (smaller_nodes == 1 ){
	edge_colour <- "gray68"
	nudge <- 0.015
	hjust <- "left"
} else {
	edge_colour <- "gray55"
	nudge <- 0
	hjust <- "center"
}

if (com_method == "twomode_c"){
	edge_colour <- "gray70"
}

if (com_method == "none" || com_method == "twomode_g"){
	edge_colour <- "gray40"
	gray_color_n <- "black"
}

rownames(lay_f) <- colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
lay_f[,1] <- lay_f[,1] - min(lay_f[,1])
lay_f[,1] <- lay_f[,1] / max(lay_f[,1])
lay_f[,2] <- lay_f[,2] - min(lay_f[,2])
lay_f[,2] <- lay_f[,2] / max(lay_f[,2])
lay_f_df <- data.frame(
	x = lay_f[,1],
	y = lay_f[,2],
	lab = rownames(lay_f)
)

if ( smaller_nodes == 1 ){
	vv <- 6.2
} else {
	vv <- 20
}

sans <- "sans"
if ( exists("saving_eps") ){
	sans <- NULL
}

#-----------------------------------------------------------------------------#
#                           Start Plotting with ggplot2                       #

#---------#
#  Edges  #

if (com_method == "cor"){ # cor

	if ( gray_scale == 1) {
		myPalette <- gray( seq(1, 0, length.out=100) )
		gray_color_n <- "black"
		if (alpha_value < 0.8) {
			alpha_value <- 0.8
		}
		p <- p + geom_edges(
			color = "black",
			size = 1.5
		)
		p <- p + geom_edges(
			aes(
				color = edge_pos
			),
			size = 1,
		)
	} else {
		myPalette <- colorRampPalette(
			rev( brewer.pal(9, "RdYlBu") )
		)(100) #Spectral
		p <- p + geom_edges(
			aes(
				color = edge_pos
			),
			size = 0.6,
		)
	}

	p <- p + scale_color_gradientn(
		colours = myPalette,
		#limits = c( min(edge_pos), limv ),
		#limits = c( 0 - limv, 0 + limv ),
		guide = guide_colourbar(
			title = "Correlation:\n",
			title.theme = element_text(
				family=sans,
				face="bold",
				size=11,
				lineheight=0.4,
				angle=0
			),
			order = 1,
			#override.aes = list(size=6, shape=22),
			label.hjust = 1,
			#reverse = TRUE,
			#ncol=2,
			#keyheight = unit(1.5,"line")
		)
	)
	p <- p + scale_fill_gradientn(
		colours = myPalette,
		guide = FALSE
	)
} else if (min_sp_tree == 1){
	edg_col2 <- p$data$edg_col
	edg_col2[edg_col2=="gray30"] <- "MST"
	edg_col2[edg_col2=="gray55"] <- "non-MST"
	edg_col2[edg_col2=="gray70"] <- "non-MST"
	p <- p + geom_edges(
		aes(linetype = as.character(line), alpha=edg_col2),
		#size = 0.8,
		color = "grey10"
	)
	p <- p + scale_alpha_discrete(
		range = c(1, 0.3),
		guide = guide_legend(
			title = "Edge:",
			keyheight = unit(1.2,"line"),
			order = 2
		)
	)
} else if ( use_weight_as_width == 1 ){
	p <- p + geom_edges(
		aes(linetype = as.character(line), alpha=weight),
		#size = 0.8,
		color = "grey10"
	)
	p <- p + scale_alpha(
		range = c(0.2, 1),
		guide = guide_legend(
			title = "Coefficient:",
			label.hjust = 1,
			keyheight = unit(1.2,"line"),
			order = 2
		)
	)
} else {
	p <- p + geom_edges(
		aes(linetype = as.character(line)),
		size = 0.4,
		color = edge_colour
	)
}

p <- p + scale_linetype_identity()

#---------#
#  Nodes  #

# words

p <- p + geom_nodes(
	aes(
		size = size * 0.41,
		color = com
	),
	alpha = 0.85,
	show.legend = F,
	shape = 16
)
p <- p + geom_nodes(
	aes(
		size = size,
		color = com,
		shape = shape
	),
	alpha = alpha_value,
	shape = 16
)
p <- p + geom_nodes(
	aes(
		size = size,
		shape = shape
	),
	colour = gray_color_n,
	show.legend = F,
	alpha = alpha_value,
	shape = 1
)
p <- p + geom_nodes( # dummy for the legend
	aes( fill = com ),
	size=0,
	colour = gray_color_n,
	alpha = 0,
	shape = 21
)

if ( use_freq_as_size == 1 ){
	# bubble plot legend configuration
	limits_a <- c(NA, NA);
	if (is.null(breaks)){
		breaks <- labeling::extended(
			min(ver_freq, na.rm=T),
			max(ver_freq, na.rm=T),
			5
		)
		breaks_a <- NULL
		for ( i in 1:length(breaks) ){
			if (
				   min(ver_freq, na.rm=T) <= breaks[i]
				&& max(ver_freq, na.rm=T) >= breaks[i]
			){
				breaks_a <- c(breaks_a, breaks[i])
			}
		}
		breaks <- breaks_a
	} else {
		breaks_a <- breaks
		if (  min(breaks) < min(ver_freq, na.rm=T) ){
			limits_a[1] <- min(breaks)
		}
		if (  max(breaks) > max(ver_freq, na.rm=T) ){
			limits_a[2] <- max(breaks)
		}
	}

	p <- p + scale_size_area(
		"Frequency",
		max_size = 30 * bubble_size / 100,
		breaks = breaks_a,
		limits = limits_a,
		guide = guide_legend(
			title = "Frequency:",
			override.aes = list(colour="black", alpha=1, shape=1),
			label.hjust = 1,
			order = 3
		)
	)
} else {
	p <- p + scale_size_area(
		max_size = vv,
		guide = F
	)
}

# variables

if ( (com_method == "twomode_c" || com_method == "twomode_g") ) {
	# (is.null(target_ids) == FALSE)

	if ( com_method == "twomode_c" ){
		var_outline_c <- "gray50"
		var_fill_c <- "#FB8072"
	}
	if ( com_method == "twomode_g" ){
		var_outline_c <- "black"
		var_fill_c <- "white"
	}
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = var_fill_c,
		show.legend = F,
		colour = NA,
		alpha = 0.8,
		size = vv * 2 / 3,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = var_fill_c,
		show.legend = F,
		colour = var_outline_c,
		alpha = alpha_value,
		size = vv,
		shape = 22
	)
}

# selected words

if ( (is.null(target_ids) == FALSE) ) {
	var_select <- target_ids

	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			fill = com_label[var_select]
		),
		show.legend = F,
		colour = NA,
		alpha = 0.8,
		size = vv * 2 / 3,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			fill = com_label[var_select]
		),
		show.legend = F,
		colour = gray_color_n,
		alpha = alpha_value,
		size = vv,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = NA,
		show.legend = F,
		colour = gray_color_n,
		alpha = alpha_value,
		size = vv * 1.4,
		shape = 22
	)
}

#---------------#
#  Node labels  #

#if ( (use_freq_as_fontsize == 1) && (use_freq_as_size == 1) ) {
#	p <- p + geom_nodetext(
#		aes(label = lab, size=size * 0.1),
#		show.legend = F,
#		family="Meiryo UI",
#		fontface=face
#	)
#}

if (
	( com_method == "com-b" || com_method == "com-g" || com_method == "com-r" || com_method == "cor")
	&& gray_scale == 1
	&& smaller_nodes == 0
){
	p <- p + geom_label(
		data = lay_f_df,
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			label = lab
		),
		size=4 * font_size,
		hjust = hjust,
		nudge_x = nudge,
		nudge_y = nudge * 1.25,
		family=font_fam,
		na.rm = T,
		label.size = NA,
		label.padding = unit(0.2 * font_size, "lines"),
		label.r = unit(0.1, "lines"),
		fontface=face
	)
} else {
	p <- p + geom_text(
		data = lay_f_df,
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			label = lab
		),
		size=4 * font_size,
		hjust = hjust,
		nudge_x = nudge,
		nudge_y = nudge * 1.25,
		family=font_fam,
		na.rm = T,
		fontface=face
	)
}

#---------------#
#  Edge labels  #

if (view_coef == 1){
	my_n_form <- function(d){
		len = length(d)
		for (i in 1:len){
			s <- d[i]
			if ( is.na(s) || is.nan(s) || is.null(s) ){
				s <- NA
			} else {
				s <- as.numeric(s)
				if (s < 1){
					s <- sprintf("%.2f",s)
					s <- substring(s, 2, 4)
				} else {
					s <- sprintf("%.1f",s)
				}
			}
			d[i] <- s
		}
		return(d)
	}
	
	p <- p + geom_edgetext(
		aes(label = my_n_form(weight)),
		color = "#000080",
		fill = NA,
		size=3.5,
	)
}

#-------------------#
#  Community color  #

if ( com_method == "com-b" || com_method == "com-g" || com_method == "com-r"){
	if ( gray_scale == 1) {
		p <- p + scale_color_grey(
			na.value = "white",
			guide = FALSE
		)
		p <- p + scale_fill_grey(
			na.value = "white",
			guide = guide_legend(
				title = "Subgraph:",
				override.aes = list(size=5.5, alpha=1, shape=22),
				keyheight = unit(1,"line"),
				ncol=2,
				order = 1
			)
		)
	} else {
		if ( length(com_m$csize[com_m$csize > 1]) <= 12 ){
			p <- p + scale_color_brewer(
				palette = "Set3",
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_brewer(
				palette = "Set3",
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		} else if (length(com_m$csize[com_m$csize > 1]) <= 20)  {
			library(ggsci)
			c20org <- col2rgb( pal_d3("category20")(20) )

			p <- p + scale_color_manual(
				values = rgb( t( ( 255 - ( 255 - c20org ) * 0.5 ) / 255  ) ),
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_manual(
				values = rgb( t( ( 255 - ( 255 - c20org ) * 0.5 ) / 255  ) ),
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		} else {
			p <- p + scale_color_hue(
				c = 50,
				l = 85,
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_hue(
				c = 50,
				l = 85,
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22, colour="gray45"),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		}
	}
}

#--------------------#
#  Centrality color  #

if ( com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e"){
	
	if (gray_scale == 1){
		myPalette <- gray( seq(1, 0.4, length.out=100) )
	} else {
		if (color_universal_design == 0){
			myPalette <- cm.colors(99)
		} else {
			library(RColorBrewer)
			col_seed <- brewer.pal(8,"YlGnBu")[1:6]

			myPalette <- colorRampPalette( col_seed )
			myPalette <- myPalette(99)
		}
	}

	p <- p + scale_color_gradientn(
		colours = myPalette,
		guide = FALSE
	)
	p <- p + scale_fill_gradientn(
		colours = myPalette,
		guide = guide_colourbar(
			title = "Centrality:\n",
			title.theme = element_text(
				family=sans,
				face="bold",
				size=11,
				lineheight=0.4,
				angle=0
			),
			order = 1,
			#override.aes = list(size=6, shape=22),
			label.hjust = 1,
			#reverse = TRUE,
			#ncol=2,
			#keyheight = unit(1.5,"line")
		)
	)
}

#----------------#
#  2 Mode color  #

if (com_method == "twomode_c"){
	p <- p + scale_color_manual(
		values = brewer.pal(8, "Spectral")[4:8],
		guide = FALSE
	)
	p <- p + scale_fill_manual(
		values = brewer.pal(8, "Spectral")[4:8],
		guide = guide_legend(
			title = "Degree:",
			order = 1,
			override.aes = list(size=5.5, shape=22, alpha=1),
			#label.hjust = "left",
			#reverse = TRUE,
			#ncol=2,
			keyheight = unit(1.2,"line")
		)
	)
}

if ( com_method == "none" || com_method == "twomode_g"){
	p <- p + scale_color_manual(
		values = c("white"),
		na.value = "white",
		guide = F
	)
	p <- p + scale_fill_manual(
		values = c("white"),
		na.value = "white",
		guide = F
	)
}

#---------------------#
#  Final adjustments  #

p <- p + theme_blank(
	base_family  = font_fam
)

if (com_method == "cor" && gray_scale == 0){ # cor
	if ( cor_var_darker == 1 ){
		col_backg <- "gray50"
	} else {
		col_backg <- "gray60"
	}
	p <- p + theme(
		panel.background = element_rect(fill = col_backg, colour = NA)
	)
}

p <- p + theme(
	legend.title    = element_text(family=sans, face="bold",  size=11, angle=0),
	legend.text     = element_text(face="plain", size=11, angle=0)
)


# make a small space between the graph and the legend
margin <- 0.04
extra  <- 0.025

m_t <- margin_top    / 100
m_b <- margin_bottom / 100
m_l <- margin_left   / 100
m_r <- margin_right  / 100

xlimv <- c(0-margin-extra-m_l, 1+margin+extra+m_r)
ylimv <- c(0-margin-m_b, 1+margin+m_t)

p <- p + coord_fixed(
	ratio = 1,
	expand = F,
	xlim = xlimv,
	ylim = ylimv
)

g <- ggplotGrob(p)

if ( length( g$grobs[[8]][[1]][[1]] ) > 1){
	if ( 
		(com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e")
		&& ( gray_scale == 0 )
	){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray45"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.25
	}
	if ( 
		(com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e")
		&& ( gray_scale == 1 )
	){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray30"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.25
	}
	if ( com_method == "cor" && gray_scale == 0){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray40"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.1
	}
}

library(grid)
library(gtable)

# fixing width of legends to 22%
if ( exists("saving_file") ){
	if ( saving_file == 0){
		target_legend_width <- convertX(
			unit( image_width * 0.22, "in" ),
			"mm"
		)
		if ( as.numeric( substr( packageVersion("ggplot2"), 1, 3) ) <= 2.1 ){ # ggplot2 <= 2.1.0
			diff_mm <- diff( c(
				convertX( g$widths[5], "mm" ),
				target_legend_width
			))
			if ( diff_mm > 0 ){
				print(diff_mm)
				g <- gtable_add_cols(g, unit(diff_mm, "mm"))
			}
		} else { # ggplot2 >= 2.2.0
			
			diff_mm <- diff( c(
				convertX( g$widths[7], "mm", valueOnly=T ) + convertX( g$widths[8], "mm", valueOnly=T ),
				target_legend_width
			))
			if ( diff_mm > 0 ){
				print(diff_mm)
				g <- gtable_add_cols(g, unit(diff_mm, "mm"))
			}
		}
	}
}

grid.draw(g)

if (exists("com_m")){
	rm("com_m")
}
if (exists("ccol_raw")){
	rm("ccol_raw")
}
if (exists("edg_mst")){
	rm("edg_mst")
}
if (exists("edg_lty")){
  rm("edg_lty")
}
ccol <- igraph::get.vertex.attribute(n2,"com")
}

# edges: 114

# min. jaccard: 0.142857142857143

# breaks: 25, 50, 75, 100


```
### **3. 共起ネットワーク分析:中学生女児(図2と対応)**



```{r 共起ネットワーク分析（中学生女児）}
d <- NULL
d <- matrix( c(2,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0
,4,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,6,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0
,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,10,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,11,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,13,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,14,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,16,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,17,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,19,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,21,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,23,1,0,0,0,1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,25,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0
,27,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0
,29,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,31,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,33,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,35,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,37,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0
,39,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,41,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,43,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,45,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1
,47,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,49,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,51,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,53,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0
,55,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0
,57,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,59,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,61,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,63,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,65,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0
,67,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,68,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,70,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,72,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0
,74,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0
,76,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1
,78,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,80,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,82,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,84,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0
,86,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,88,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,90,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,92,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,94,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,96,0,1,0,0,1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,98,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,100,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,101,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,103,0,0,1,1,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,104,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0
,106,0,0,0,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,108,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,110,1,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,112,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,114,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0
,116,0,0,2,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,118,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,120,1,1,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0
,122,0,0,1,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,124,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,126,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,128,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,130,1,0,0,0,0,0,0,0,0,2,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0
,132,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,134,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,136,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,137,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,139,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,141,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,143,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0
,145,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,147,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0
,149,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,151,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0
,153,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0
,155,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,157,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0
,159,0,0,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,161,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0
,163,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,165,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,167,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,169,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,171,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,173,0,2,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,175,1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1
,177,1,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0
,179,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,181,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,183,0,0,1,1,2,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,185,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,187,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0
,189,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,191,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,193,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,195,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,197,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0
,199,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0
,201,0,0,2,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,203,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,205,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,207,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,209,0,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,211,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,213,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0
,215,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0
,217,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,1,0,0,0,1,1,0,0,0,0,1,1,1,0,0,0,0,0,0
,219,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,221,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,223,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,225,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,228,0,0,1,1,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,230,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0
,232,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0
,234,1,1,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,236,0,0,0,0,2,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,238,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,240,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,242,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,244,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0
,246,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,248,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0
,250,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,251,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,253,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0
,255,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,257,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,259,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0
,261,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0
,263,0,0,1,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,0,0,0
,265,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,267,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,269,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,271,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,273,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,275,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,277,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,279,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0
,281,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,283,0,0,0,0,1,1,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,285,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,287,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,289,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0
,291,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,293,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0
,295,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,296,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,297,0,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,298,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,300,2,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,302,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,2,0,0,0,0,0,0
,304,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,305,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,306,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0
,308,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,310,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,312,0,0,1,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,1,0,0,0
,314,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,316,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0
,318,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0
,320,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,322,1,1,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,324,0,0,1,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,325,0,0,0,1,0,1,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,326,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,1,0,0,1,0,0
,328,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,330,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,332,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,334,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0
,336,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,338,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,340,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,1,1,0,0,0,0,0
,341,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,343,1,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,344,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,1,0,0,0,0,0
,346,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0
,348,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,350,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,352,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,354,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,355,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,356,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
,358,0,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0
,360,0,1,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0), byrow=T, nrow=189, ncol=46 )
d <- d[,-1]
colnames(d) <- c("\u5b66\u6821","\u6559\u54e1","\u6bcd\u89aa","\u88ab\u5bb3","\u53cb\u4eba","\u8b66\u5bdf","\u8a34\u3048","\u990a\u7236","\u5e02\u5f79\u6240","\u5b9f\u7236","\u5fc3\u7406","\u7956\u6bcd","\u75c5\u9662","\u76f8\u8ac7","\u958b\u793a","\u901a\u544a","\u767a\u898b","\u9762\u63a5","\u30e1\u30e2","\u8650\u5f85","\u65bd\u8a2d","\u4fe1\u983c","\u8074\u53d6","\u901a\u5831","\u598a\u5a20","\u4fdd\u8b77","\u8a71","\u6027\u7684","\u81ea\u3089","DV","\u5150\u76f8","\u990a\u8b77\u6559\u8aed","\u8a9e\u308b","\u805e\u304d\u53d6\u308b","\u8a34\u3048\u308b","\u6253\u3061\u660e\u3051\u308b","\u805e\u304f","\u53d7\u3051\u308b","\u5150","\u5bb6","\u59c9","\u6027","\u5f1f","\u7236","\u59b9")
doc_length_mtr <- matrix( c( 12,6,11,7,16,10,8,4,6,4,9,6,6,4,9,6,6,4,9,6,14,9,17,6,25,16,19,11,21,11,7,4,20,14,17,11,26,16,25,16,9,6,11,7,6,4,12,9,13,9,11,7,23,14,13,6,13,6,7,4,7,4,7,4,16,5,10,5,15,10,10,6,12,5,14,8,13,7,10,8,7,4,7,4,9,7,28,14,10,6,19,11,5,3,32,20,10,6,19,12,10,6,16,11,10,6,22,14,20,12,17,11,13,8,10,6,20,13,13,7,19,12,23,12,20,13,7,5,7,4,9,6,18,12,57,34,20,11,12,8,5,3,12,7,11,8,16,11,22,12,7,4,22,12,9,6,17,9,16,9,4,3,9,6,24,14,10,5,14,9,5,3,5,3,5,3,19,11,33,24,37,25,26,16,11,7,7,4,29,19,10,6,12,8,7,4,19,12,39,25,8,5,14,10,22,12,21,14,10,6,7,5,18,12,13,9,19,11,9,6,27,15,32,20,11,6,4,3,8,4,8,5,20,15,29,22,32,25,18,11,26,16,8,5,14,10,11,7,7,5,7,5,11,6,10,5,6,3,14,7,16,10,17,12,7,5,14,10,23,18,10,6,22,10,13,8,15,10,14,9,9,6,9,5,20,12,25,15,11,7,13,7,8,6,33,20,11,8,11,7,10,7,10,6,29,19,13,9,18,12,38,26,4,2,3,2,5,3,8,5,7,4,31,18,8,5,15,10,16,10,11,7,14,9,16,12,24,16,36,24,5,3,8,6,11,7,14,9,10,6,10,6,21,14,23,16,22,13,20,13,10,5,13,5,33,19,13,6,4,3,4,3,13,8,17,11,17,11), ncol=2, byrow=T)
colnames(doc_length_mtr) <- c("length_c", "length_w")
color_universal_design <- 1

d <- t(d)
# END: DATA
edges <- 100
th <- -1
font_size <- 1
margin_top <- 0
margin_bottom <- 0
margin_left <- 0
margin_right <- 0
view_coef <- 0
fix_lab <- 1
use_freq_as_size <- 1
bubble_size <- 100
use_weight_as_width <- 1
smaller_nodes <- 0
text_font <- 1
min_sp_tree <- 0
min_sp_tree_only <- 0
cor_var <- 0
cor_var_darker <- 0
cor_var_min <- -1
cor_var_max <- 1
use_alpha <- 1
gray_scale <- 0
method_coef <- "binary"

standardize_coef <- 1
breaks <- NULL
# additional_plots: 0

com_method <- "com-g"


# Count frequency of each word
freq <- NULL
for (i in 1:length( rownames(d) )) {
	freq[i] = sum( d[i,] )
}

# Compute co-occurrence coefficient
if ( (exists("doc_length_mtr")) &! (method_coef == "binary")){
	leng <- as.numeric(doc_length_mtr[,2])
	leng[leng ==0] <- 1
	d <- t(d)
	d <- d / leng
	d <- d * 1000
	d <- t(d)
}
if (method_coef == "euclid"){ # standardize for each word
	d <- t( scale( t(d) ) )
}

dr <- d
library(amap)
d <- Dist(d,method=method_coef)

d <- as.matrix(d)
if ( method_coef == "euclid" ){
	d <- max(d) - d
	d <- d / max(d)
} else {
	d <- 1 - d
}

# For twomode
if ( exists("com_method") ){
	if ( com_method == "twomode_c" || com_method == "twomode_g" ){
		# delete unnecessary edges
		d[1:n_words,] <- 0

		# standardize coef.
		if ( standardize_coef == 1 ) {
			std  <- d[(n_words+1):nrow(d),1:n_words]
			chkm <- std
			
			std <- t(std)
			std <- scale(std, center=T, scale=F)
			std <- t(std)
	
			chkm_temp <- chkm[!is.na(chkm)]
			std_range <- max(chkm_temp) - min(chkm_temp[chkm_temp!=0])
			std <- std - min(std[!is.na(std)])        # min = 0
			std <- std / max(std[!is.na(std)])        # max = 1
			std <- std * std_range                    # set range
			std <- std + min(chkm_temp[chkm_temp!=0]) # set min
			chkm_temp <- NULL
			
			std[chkm == 0] <- 0
			d[(n_words+1):nrow(d),1:n_words] <- std
		}
	}
}

# Make a graph
# For igraph > 1.0.0
library(igraph)
new_igraph <- 0
igraph_ver <- (
	  as.numeric( substr(sessionInfo()$otherPkgs$igraph$Version, 1,1) ) * 10
	+ as.numeric( substr(sessionInfo()$otherPkgs$igraph$Version, 3,3) )
)
if ( igraph_ver > 5){
	new_igraph <- 1
}

n <- graph.adjacency(d, mode="lower", weighted=T, diag=F)
n <- igraph::set.vertex.attribute(
	n,
	"name",
	(0+new_igraph):(length(d[1,])-1+new_igraph),
	as.character( 1:length(d[1,]) )
)

# Prepare for deleting weak edges
el <- data.frame(
	edge1            = get.edgelist(n,name=T)[,1],
	edge2            = get.edgelist(n,name=T)[,2],
	weight           = igraph::get.edge.attribute(n, "weight"),
	stringsAsFactors = FALSE
)

# making backup of coef.
if ( exists("com_method") ){
	if (
		( com_method == "twomode_c" || com_method == "twomode_g" )
		&& ( standardize_coef == 1 )
	){
		dbb <- d
		dbb[(n_words+1):nrow(dbb),1:n_words] <- chkm
		
		nbb <- graph.adjacency(dbb, mode="lower", weighted=T, diag=F)
		nbb <- igraph::set.vertex.attribute(
			nbb,
			"name",
			(0+new_igraph):(length(dbb[1,])-1+new_igraph),
			as.character( 1:length(dbb[1,]) )
		)
		
		elbb <- data.frame(
			edge1            = get.edgelist(nbb,name=T)[,1],
			edge2            = get.edgelist(nbb,name=T)[,2],
			weight_b           = igraph::get.edge.attribute(nbb, "weight"),
			stringsAsFactors = FALSE
		)
		
		if ( identical(el[,1:2], elbb[,1:2]) == F ){
			print("Error: could not make coef. backup!")
		}
		
		el <- data.frame(el, elbb$weight_b)
	}
}

# Find a threshold value
if (th < 0){
	if(edges > length(el[,1])){
		edges <- length(el[,1])
	}
	th = quantile(
		el$weight,
		names = F,
		probs = 1 - edges / length(el[,1])
	)
}

# Delete weak edges and make a graph again
el2 <- subset(el, el[,3] >= th)
if ( nrow(el2) == 0 ){
	stop(message = "No edges to draw!", call. = F)
}
n2  <- graph.edgelist(
	matrix( as.matrix(el2)[,1:2], ncol=2 ),
	directed	=F
)
n2 <- igraph::set.edge.attribute(
	n2,
	"weight",
	(0+new_igraph):(length(get.edgelist(n2)[,1])-1+new_igraph),
	el2[,3]
)

# use the backup of coef.
if ( exists("com_method") ){
	if (
		( com_method == "twomode_c" || com_method == "twomode_g" )
		&& ( standardize_coef == 1 )
	){
		n2 <- igraph::set.edge.attribute(
			n2,
			"weight",
			(0+new_igraph):(length(get.edgelist(n2)[,1])-1+new_igraph),
			el2[,4]
		)
	}
}

if ( min_sp_tree_only == 1 ){
	n2 <- minimum.spanning.tree(
		n2,
		weights = 1 - igraph::get.edge.attribute(n2, "weight"),
		algorithm="prim"
	)
}


if (length(igraph::get.vertex.attribute(n2,"name")) < 2){
	com_method <- "none"
}

# Centrality
if ( com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e"){
	ccol <- NULL
	if (com_method == "cnt-b"){                   # betweenness
		ccol <- igraph::betweenness(
			n2,
			v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph),
			directed=F
		)
	}
	if (com_method == "cnt-d"){                   # degree
		ccol <-  igraph::degree(
			n2,
			v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph)
		)
	}
	if (com_method == "cnt-e"){                   # evcent
		try(
			ccol <- igraph::evcent(n2)$vector,
			silent = T
		)
	}
	ccol_raw <- ccol

	edg_col   <- "gray55"
	edg_lty   <- 1
}

# Community detection
if (com_method == "com-b" || com_method == "com-g" || com_method == "com-r"){
	merge_step <- function(n2, m){                # \u5171\u901a\u5229\u7528\u306e\u95a2\u6570
		for ( i in 1:( trunc( length( m ) / 2 ) ) ){
			temp_csize <- community.to.membership(n2, m,i)$csize
			num_max   <- max( temp_csize )
			num_alone <- sum( temp_csize[ temp_csize == 1 ] )
			num_cls   <- length( temp_csize[temp_csize > 1] )
			#print( paste(i, "a", num_alone, "max", num_max, "cls", num_cls) )
			if (
				# \u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u5168\u30ce\u30fc\u30c9\u6570\u306e22.5%\u4ee5\u4e0a
				   num_max / length(igraph::get.vertex.attribute(n2,"name")) >= 0.225
				# \u304b\u3064\u3001\u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u5358\u72ec\u30ce\u30fc\u30c9\u6570\u3088\u308a\u3082\u5927\u304d\u3044
				&& num_max > num_alone
				# \u304b\u3064\u3001\u30b5\u30a4\u30ba\u304c2\u4ee5\u4e0a\u306e\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u6570\u304c12\u672a\u6e80
				&& num_cls < 12
			){
				return(i)
			}
			# \u6700\u5927\u30b3\u30df\u30e5\u30cb\u30c6\u30a3\u30b5\u30a4\u30ba\u304c\u30ce\u30fc\u30c9\u6570\u306e40%\u3092\u8d8a\u3048\u308b\u76f4\u524d\u3067\u6253\u3061\u5207\u308a
			if (num_max / length(igraph::get.vertex.attribute(n2,"name")) >= 0.4 ){
				return(i-1)
			}
		}
		return( trunc(length( m ) / 2) )
	}
	# For igraph > 1.0.0
	if (com_method == "com-b"){                   # Betweenness
		com   <- edge.betweenness.community(n2, directed=F)    
		if (igraph_ver < 10){
			com_m <- community.to.membership(
				n2, com$merges, merge_step(n2,com$merges)
			)
			com_m$membership <- com_m$membership + new_igraph
		}
	}
	if (com_method == "com-g"){                   # Modularity
		com   <- fastgreedy.community   (n2, merges=TRUE, modularity=TRUE)
		if (igraph_ver < 10){
			com_m <- community.to.membership(
				n2, com$merges, merge_step(n2,com$merges)
			)
			com_m$membership <- com_m$membership + new_igraph
		}
	}
	if (com_method == "com-r"){                   # Random walks
		com   <-  walktrap.community(
			n2,
			weights=igraph::get.edge.attribute(n2, "weight")
		)
		if (igraph_ver < 10){
			com_m <- NULL
			com_m$membership <- com$membership
			com_m$csize      <- table(com$membership)
		}
	}
	if (igraph_ver >= 10){
		com_m <- NULL
		com_m$membership <- as.vector( membership(com) )
		com_m$csize      <- table(com_m$membership)
	}

	# Configure Edges
	edg_lty <- NULL
	edg_col <- NULL
	for (i in 1:nrow(get.edgelist(n2,name=F))){
		if (
			   com_m$membership[ get.edgelist(n2,name=F)[i,1] + 1 - new_igraph]
			== com_m$membership[ get.edgelist(n2,name=F)[i,2] + 1 - new_igraph]
		){
			edg_col <- c( edg_col, "gray55" )
			edg_lty <- c( edg_lty, 1 )
		} else {
			edg_col <- c( edg_col, "gray" )
			edg_lty <- c( edg_lty, 3 )
		}
	}
}

# \u5909\u6570\u30fb\u898b\u51fa\u3057\u3092\u5229\u7528\u3059\u308b\u5834\u5408\u306e\u30ab\u30e9\u30fc
if (com_method == "twomode_c" || com_method == "twomode_g"){
	if ( exists("var_select") ){
		var_select_bak <- var_select
	}
	
	var_select <- substring(
		colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ],
		1,
		2
	) == "<>"

	if (length(var_select[var_select==TRUE]) == 0 && exists("var_select_bak")){
		var_select <- var_select_bak;
	}
}

if (com_method == "twomode_c"){
	ccol <-  igraph::degree(
		n2,
		v=(0+new_igraph):(length(igraph::get.vertex.attribute(n2,"name"))-1+new_igraph)
	)
	# ggplot2
	ccol_raw <- ccol
	ccol_raw[var_select] <- NA
	ccol_raw[ccol_raw >= 5] <- 5
	ccol_raw <- as.character(ccol_raw)
	ccol_raw[ccol_raw=="5"] <- "5+"

	edg_col   <- "gray70"
	edg_lty   <- 1

}

# \u30ab\u30e9\u30fc\u30ea\u30f3\u30b0\u300c\u306a\u3057\u300d\u306e\u5834\u5408\u306e\u7dda\u306e\u8272\uff082010 12/4\uff09
if (com_method == "none" || com_method == "twomode_g"){
	edg_lty <- 1
	edg_col   <- "gray40"
}

if (com_method == "twomode_g"){
	edg_lty <- 3
}

# Minimum Spanning Tree
if ( min_sp_tree == 1 ){
	# MST\u306e\u691c\u51fa
	mst <- minimum.spanning.tree(
		n2,
		weights = 1 - igraph::get.edge.attribute(n2, "weight"),
		algorithm="prim"
	)

	# MST\u306b\u5408\u81f4\u3059\u308bedge\u3092\u5f37\u8abf
	#if (length(edg_col) == 1){
		edg_col <- rep("gray55", length( igraph::get.edge.attribute(n2, "weight") )) 
	#}

	n2_edges  <- get.edgelist(n2,name=T);
	mst_edges <- get.edgelist(mst,name=T);

	if (exists("edg_lty") == F){
		edg_lty <- 1
	}
	for ( i in 1:ecount(n2) ){
		name_n2 <- paste(
			n2_edges[i,1],
			n2_edges[i,2]
		)
		for ( j in 1:ecount(mst) ){
			name_mst <- paste(
				mst_edges[j,1],
				mst_edges[j,2]
			)
			if ( name_n2 == name_mst ){
				edg_col[i]   <- "gray30"                   # edge color
				if ( length(edg_lty) > 1 ){
					edg_lty[i] <- 1                        # edge linetype
				}
				break
			}
		}
	}
	edg_mst <- edg_col
}

# \u521d\u671f\u914d\u7f6e
lay <- NULL
if ( length(igraph::get.vertex.attribute(n2,"name")) >= 3 ){
	d4l <- as.dist( shortest.paths(n2) )
	if ( min(d4l) < 1 ){
		d4l <- as.dist( shortest.paths(n2, weights=NA ) )
	}
	if ( max(d4l) == Inf){
		d4l[d4l == Inf] <- vcount(n2)
	}
	try( lay <- cmdscale( d4l, k=2 ), silent=TRUE )
	if ( is.null(lay) == F ){
		lay <- round(lay, digits=5)
		check4fr <- function(d){
			chk <- 0
			for (i in combn( length(d[,1]), 2, simplify=F ) ){
				if (
					   d[i[1],1] == d[i[2],1]
					&& d[i[1],2] == d[i[2],2]
				){
					return( i[1] )
				}
			}
			return( NA )
		}
		salt <- 1
		while ( is.na(check4fr(lay)) == 0 ){
			mv <-  check4fr(lay)
			lay[mv,1] <- lay[mv,1] + 0.001 * salt
			# Much faster if you add salt. But layout will be changed.
			#salt <- salt + 0.2
			#print( paste( "Moved:", mv ) )
		}
	}
}

# \u914d\u7f6e
set.seed(100)
if (
	   (com_method == "twomode_c" || com_method == "twomode_g")
	&& ( igraph::is.connected(n2) )
){
	# For igraph > 1.0.0
	if (igraph_ver >= 10){
		lay_f <- layout.kamada.kawai(
			n2,
			#coords   = lay,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	} else {
		lay_f <- layout.kamada.kawai(
			n2,
			start   = lay,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	}
} else {
	# For igraph > 1.0.0
	if (igraph_ver >= 10){
		lay_f <- layout.fruchterman.reingold(
			n2,
			#coords   = lay,
			niter   = vcount(n2) * 512,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	} else {
		lay_f <- layout.fruchterman.reingold(
			n2,
			start   = lay,
			niter   = vcount(n2) * 512,
			weights = igraph::get.edge.attribute(n2, "weight")
		)
	}
}

lay_f <- scale(lay_f,center=T, scale=F)
for (i in 1:2){
	lay_f[,i] <- lay_f[,i] - min(lay_f[,i]); # \u6700\u5c0f\u30920\u306b
	lay_f[,i] <- lay_f[,i] / max(lay_f[,i]); # \u6700\u5927\u30921\u306b
	lay_f[,i] <- ( lay_f[,i] - 0.5 ) * 1.96;
}


# \u5916\u90e8\u5909\u6570\u30fb\u898b\u51fa\u3057\u3092\u4f7f\u3046\u5834\u5408\u306e\u5f62\u72b6\u3084\u30b5\u30a4\u30ba
if (com_method == "twomode_c" || com_method == "twomode_g"){
	# \u8b58\u5225\u7528\u306e\u300c<>\u300d\u3092\u5916\u3059
	colnames(d)[
		substring(colnames(d), 1, 2) == "<>"
	] <- substring(
		colnames(d)[
			substring(colnames(d), 1, 2) == "<>"
		],
		3,
		nchar(colnames(d)[
			substring(colnames(d), 1, 2) == "<>"
		],type="c")
	)
}


if ( exists("saving_emf") || exists("saving_eps") ){
	use_alpha <- 0           # need something before \n (gui_widget::r_net)
	use_weight_as_width <- 0 # need something before \n (gui_widget::r_net)
}

target_ids <-  NULL
if ( exists("target_words") ){
	# get word IDs
	for (i in 1:length( igraph::get.vertex.attribute(n2,"name") ) ){
		for (w in target_words){
			if (
				colnames(d)[ as.numeric(igraph::get.vertex.attribute(n2,"name")[i]) ]
				== w
			){
				target_ids <- c(target_ids, i)
			}
		}
	}
}

edge_label <- NULL

font_fam <- "Meiryo UI"
if ( exists("PERL_font_family") ){
	font_fam <- PERL_font_family
}

if ( length(igraph::get.vertex.attribute(n2,"name")) > 1 ){
	if (fix_lab == 1){
		if (exists("if_fixed") == 0){
			plot.new()
			plot.window(xlim=c(-1, 1), ylim=c(-1, 1))
			
			labcd <- NULL
			labcd$x <- lay_f[,1]
			labcd$y <- lay_f[,2]
			word_labs <- colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
	
			library(wordcloud)

# fix for "wordlayout" function
filename <- tempfile()
writeLines("wordlayout <- function (x, y, words, cex = 1, rotate90 = FALSE, xlim = c(-Inf, 
	Inf), ylim = c(-Inf, Inf), tstep = 0.1, rstep = 0.1, ...) 
{
	tails <- \"g|j|p|q|y\"
	n <- length(words)
	sdx <- sd(x, na.rm = TRUE)
	sdy <- sd(y, na.rm = TRUE)
	iterations <- 0
	if (sdx == 0) 
		sdx <- 1
	if (sdy == 0) 
		sdy <- 1
	if (length(cex) == 1) 
		cex <- rep(cex, n)
	if (length(rotate90) == 1) 
		rotate90 <- rep(rotate90, n)
	boxes <- list()
	for (i in 1:length(words)) {
		rotWord <- rotate90[i]
		r <- 0
		theta <- runif(1, 0, 2 * pi)
		x1 <- xo <- x[i]
		y1 <- yo <- y[i]
		wid <- strwidth(words[i], cex = cex[i], ...)
		ht <- strheight(words[i], cex = cex[i], ...)
		if (grepl(tails, words[i])) 
			ht <- ht + ht * 0.2
		if (rotWord) {
			tmp <- ht
			ht <- wid
			wid <- tmp
		}
		isOverlaped <- TRUE
		while (isOverlaped) {
			if (!.overlap(x1 - 0.5 * wid, y1 - 0.5 * ht, wid, 
				ht, boxes) && x1 - 0.5 * wid > xlim[1] && y1 - 
				0.5 * ht > ylim[1] && x1 + 0.5 * wid < xlim[2] && 
				y1 + 0.5 * ht < ylim[2]) {
				boxes[[length(boxes) + 1]] <- c(x1 - 0.5 * wid, 
				  y1 - 0.5 * ht, wid, ht)
				isOverlaped <- FALSE
			}
			else {
				theta <- theta + tstep
				r <- r + rstep * tstep/(2 * pi)
				x1 <- xo + sdx * r * cos(theta)
				y1 <- yo + sdy * r * sin(theta)
				iterations <- iterations + 1
				if (iterations > 500000){
					boxes[[length(boxes) + 1]] <- c(x1 - 0.5 * wid, 
				  y1 - 0.5 * ht, wid, ht)
					isOverlaped = FALSE
				}
			}
		}
	}
	print( paste(\"iterations: \", iterations) )
	result <- do.call(rbind, boxes)
	colnames(result) <- c(\"x\", \"y\", \"width\", \"ht\")
	rownames(result) <- words
	result
}
", filename)
if ( packageVersion("wordcloud") == 2.4){
	insertSource(filename, package="wordcloud", force=FALSE)
}
nc <- wordlayout(
				labcd$x,
				labcd$y,
				word_labs,
				cex=1.28,
				xlim=c( -1, 1 ),
				ylim=c( -1, 1 )
			)
	
			xorg <- labcd$x
			yorg <- labcd$y
			labcd$x <- nc[,1] + .5 * nc[,3]
			labcd$y <- nc[,2] + .5 * nc[,4]
			lay_f <- cbind(labcd$x, labcd$y)
	
			if_fixed <- 1
		}
	}

#-----------------------------------------------------------------------------#
#                       Prepare for Plotting with ggplot2                     #

#------------------------------------------------#
#  get ready for ggplot2 graph drawing (0): cor  #

if ( com_method == "cor" ){  # cor
	dr <- as.data.frame( t(dr) )
	dv <- data.frame(
	  khvar_ = as.numeric(v0)
	)
	dr <- cbind(dr,dv)

	edge_pos <- NULL
	edges <- get.edgelist(n2, names=TRUE)
	for (i in 1:nrow(edges)){
		i1 <- as.numeric( edges[i,1] )
		i2 <- as.numeric( edges[i,2] )
		
		edge_pos <- c(
			edge_pos,
			cor(
				as.numeric( dr[,i1] > 0 & dr[,i2] >0 ),
				dr$khvar_,
				method="pearson"
			)
			#mean( dr[dr[,i1] > 0 & dr[,i2] >0,]$khvar_ )
		)
	}

	if ( length( edge_pos[is.na(edge_pos) == F] ) == 0 ){
		edge_pos <- 0
	}

	#n2 <- igraph::set.edge.attribute(
	#	n2,
	#	"edge_pos_o",
	#	1:length(igraph::get.edge.attribute(n2,"weight")),
	#	edge_pos
	#)

	#edge_pos <- edge_pos - mean(edge_pos)
	#edge_pos <- edge_pos / sd(edge_pos)
	##edge_pos <- edge_pos * 10 + 50

	#limv <- 0.15
	#maxv <- max( abs( edge_pos ) )
	
	#if ( limv < maxv ){
	#	edge_pos[edge_pos > limv]  <- limv
	#	edge_pos[edge_pos < -limv] <- -limv
	#}

	edge_pos[edge_pos > cor_var_max] <- cor_var_max
	edge_pos[edge_pos < cor_var_min] <- cor_var_min
	
	n2 <- igraph::set.edge.attribute(
		n2,
		"edge_pos",
		1:length(igraph::get.edge.attribute(n2,"weight")),
		edge_pos
	)

	ver_pos <- NULL
	vertices <- as.numeric( igraph::get.vertex.attribute(n2,"name") )
	for (i in 1:length(vertices) ){
		ver_pos <- c(
			ver_pos,
			cor(
				as.numeric( dr[,vertices[i]] > 0 ),
				dr$khvar_,
				method="pearson"
			)
		)
	}

	if ( length( ver_pos[is.na(ver_pos) == F] ) == 0 ){
	  ver_pos <- 0
	}

	ver_pos[ver_pos > max(edge_pos)] <- max(edge_pos)
	ver_pos[ver_pos < min(edge_pos)] <- min(edge_pos)

	#n2 <- igraph::set.vertex.attribute(
	#	n2,
	#	"ver_pos",
	#	1:length(igraph::get.vertex.attribute(n2,"name")),
	#	ver_pos
	#)
	ccol_raw <- ver_pos
	if ( is.null( igraph::get.vertex.attribute(n2,"com") ) == FALSE ){
		n2 <- remove.vertex.attribute(n2, "com")
		edg_lty <- 1
	}
}

#-----------------------------------------------#
#  get ready for ggplot2 graph drawing (1): n2  #

n2 <- igraph::set.vertex.attribute(
	n2,
	"lab",
	1:length(igraph::get.vertex.attribute(n2,"name")),
	colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
)

ver_freq <- freq[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]

if (com_method == "twomode_c" || com_method == "twomode_g"){
	ver_freq[var_select] <- NA
}

if ( is.null(target_ids) == FALSE ){
	ver_freq[target_ids] <- NA
}

if (use_freq_as_size == 0){
	ver_freq[ver_freq > 0] <- 1
}

n2 <- igraph::set.vertex.attribute(
	n2,
	"size",
	1:length(igraph::get.vertex.attribute(n2,"name")),
	ver_freq
)

# For community detection

if ( exists("ccol") ){ # clean up previous data
	try( n2 <- remove.vertex.attribute(n2, "com"), silent=T )
}

if ( exists("com_m") ){
	com_label <- NULL

	for (h in 1:length(com_m$membership)){
		i <- com_m$membership[h]
		if ( com_m$csize[i] > 1 ) {
			if (i < 10){
				com_label <- c(
					com_label,
					paste("0", as.character(i), "   ", sep="")
				)
			} else {
				com_label <- c(com_label, as.character(i))
			}
		} else {
			com_label <- c(com_label, NA)
		}
	}

	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		com_label
	)
}

if ( exists("ccol_raw") ){
	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		ccol_raw
	)
	com_label <- ccol_raw
}

if ( com_method == "none" || com_method == "twomode_g"){
	n2 <- igraph::set.vertex.attribute(
		n2,
		"com",
		1:length(igraph::get.vertex.attribute(n2,"name")),
		rep( "na", length(igraph::get.vertex.attribute(n2,"name")) )
	)
	com_label <- NA
}

if ( exists("edg_mst") ){
	n2 <- igraph::set.edge.attribute(
		n2,
		"edg_col",
		1:length(igraph::get.edge.attribute(n2,"weight")),
		edg_mst
	)
	#print(edg_mst)
}

if ( exists("edg_lty") == F ){
	edg_lty <- 1
}
edg_lty[edg_lty==1] <- "solid"
edg_lty[edg_lty==3] <- "dotted"

n2 <- igraph::set.edge.attribute(
	n2,
	"line",
	1:length(igraph::get.edge.attribute(n2,"weight")),
	edg_lty
)

#-------------------------------------------------------#
#  get ready for ggplot2 graph drawing (2): parameters  #

library(ggplot2)
library(ggnetwork)

p <- ggplot(
	ggnetwork(n2, layout=lay_f),
	aes(x = x, y = y, xend = xend, yend = yend),
)

if (use_alpha == 1){
	alpha_value = 0.62
	gray_color_n <- "gray20"
} else {
	alpha_value = 1
	gray_color_n <- "gray40"

}

if (text_font == 2){
	face <- "bold"
} else {
	face <- "plain"
}
if (smaller_nodes == 1 ){
	edge_colour <- "gray68"
	nudge <- 0.015
	hjust <- "left"
} else {
	edge_colour <- "gray55"
	nudge <- 0
	hjust <- "center"
}

if (com_method == "twomode_c"){
	edge_colour <- "gray70"
}

if (com_method == "none" || com_method == "twomode_g"){
	edge_colour <- "gray40"
	gray_color_n <- "black"
}

rownames(lay_f) <- colnames(d)[ as.numeric( igraph::get.vertex.attribute(n2,"name") ) ]
lay_f[,1] <- lay_f[,1] - min(lay_f[,1])
lay_f[,1] <- lay_f[,1] / max(lay_f[,1])
lay_f[,2] <- lay_f[,2] - min(lay_f[,2])
lay_f[,2] <- lay_f[,2] / max(lay_f[,2])
lay_f_df <- data.frame(
	x = lay_f[,1],
	y = lay_f[,2],
	lab = rownames(lay_f)
)

if ( smaller_nodes == 1 ){
	vv <- 6.2
} else {
	vv <- 20
}

sans <- "sans"
if ( exists("saving_eps") ){
	sans <- NULL
}

#-----------------------------------------------------------------------------#
#                           Start Plotting with ggplot2                       #

#---------#
#  Edges  #

if (com_method == "cor"){ # cor

	if ( gray_scale == 1) {
		myPalette <- gray( seq(1, 0, length.out=100) )
		gray_color_n <- "black"
		if (alpha_value < 0.8) {
			alpha_value <- 0.8
		}
		p <- p + geom_edges(
			color = "black",
			size = 1.5
		)
		p <- p + geom_edges(
			aes(
				color = edge_pos
			),
			size = 1,
		)
	} else {
		myPalette <- colorRampPalette(
			rev( brewer.pal(9, "RdYlBu") )
		)(100) #Spectral
		p <- p + geom_edges(
			aes(
				color = edge_pos
			),
			size = 0.6,
		)
	}

	p <- p + scale_color_gradientn(
		colours = myPalette,
		#limits = c( min(edge_pos), limv ),
		#limits = c( 0 - limv, 0 + limv ),
		guide = guide_colourbar(
			title = "Correlation:\n",
			title.theme = element_text(
				family=sans,
				face="bold",
				size=11,
				lineheight=0.4,
				angle=0
			),
			order = 1,
			#override.aes = list(size=6, shape=22),
			label.hjust = 1,
			#reverse = TRUE,
			#ncol=2,
			#keyheight = unit(1.5,"line")
		)
	)
	p <- p + scale_fill_gradientn(
		colours = myPalette,
		guide = FALSE
	)
} else if (min_sp_tree == 1){
	edg_col2 <- p$data$edg_col
	edg_col2[edg_col2=="gray30"] <- "MST"
	edg_col2[edg_col2=="gray55"] <- "non-MST"
	edg_col2[edg_col2=="gray70"] <- "non-MST"
	p <- p + geom_edges(
		aes(linetype = as.character(line), alpha=edg_col2),
		#size = 0.8,
		color = "grey10"
	)
	p <- p + scale_alpha_discrete(
		range = c(1, 0.3),
		guide = guide_legend(
			title = "Edge:",
			keyheight = unit(1.2,"line"),
			order = 2
		)
	)
} else if ( use_weight_as_width == 1 ){
	p <- p + geom_edges(
		aes(linetype = as.character(line), alpha=weight),
		#size = 0.8,
		color = "grey10"
	)
	p <- p + scale_alpha(
		range = c(0.2, 1),
		guide = guide_legend(
			title = "Coefficient:",
			label.hjust = 1,
			keyheight = unit(1.2,"line"),
			order = 2
		)
	)
} else {
	p <- p + geom_edges(
		aes(linetype = as.character(line)),
		size = 0.4,
		color = edge_colour
	)
}

p <- p + scale_linetype_identity()

#---------#
#  Nodes  #

# words

p <- p + geom_nodes(
	aes(
		size = size * 0.41,
		color = com
	),
	alpha = 0.85,
	show.legend = F,
	shape = 16
)
p <- p + geom_nodes(
	aes(
		size = size,
		color = com,
		shape = shape
	),
	alpha = alpha_value,
	shape = 16
)
p <- p + geom_nodes(
	aes(
		size = size,
		shape = shape
	),
	colour = gray_color_n,
	show.legend = F,
	alpha = alpha_value,
	shape = 1
)
p <- p + geom_nodes( # dummy for the legend
	aes( fill = com ),
	size=0,
	colour = gray_color_n,
	alpha = 0,
	shape = 21
)

if ( use_freq_as_size == 1 ){
	# bubble plot legend configuration
	limits_a <- c(NA, NA);
	if (is.null(breaks)){
		breaks <- labeling::extended(
			min(ver_freq, na.rm=T),
			max(ver_freq, na.rm=T),
			5
		)
		breaks_a <- NULL
		for ( i in 1:length(breaks) ){
			if (
				   min(ver_freq, na.rm=T) <= breaks[i]
				&& max(ver_freq, na.rm=T) >= breaks[i]
			){
				breaks_a <- c(breaks_a, breaks[i])
			}
		}
		breaks <- breaks_a
	} else {
		breaks_a <- breaks
		if (  min(breaks) < min(ver_freq, na.rm=T) ){
			limits_a[1] <- min(breaks)
		}
		if (  max(breaks) > max(ver_freq, na.rm=T) ){
			limits_a[2] <- max(breaks)
		}
	}

	p <- p + scale_size_area(
		"Frequency",
		max_size = 30 * bubble_size / 100,
		breaks = breaks_a,
		limits = limits_a,
		guide = guide_legend(
			title = "Frequency:",
			override.aes = list(colour="black", alpha=1, shape=1),
			label.hjust = 1,
			order = 3
		)
	)
} else {
	p <- p + scale_size_area(
		max_size = vv,
		guide = F
	)
}

# variables

if ( (com_method == "twomode_c" || com_method == "twomode_g") ) {
	# (is.null(target_ids) == FALSE)

	if ( com_method == "twomode_c" ){
		var_outline_c <- "gray50"
		var_fill_c <- "#FB8072"
	}
	if ( com_method == "twomode_g" ){
		var_outline_c <- "black"
		var_fill_c <- "white"
	}
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = var_fill_c,
		show.legend = F,
		colour = NA,
		alpha = 0.8,
		size = vv * 2 / 3,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = var_fill_c,
		show.legend = F,
		colour = var_outline_c,
		alpha = alpha_value,
		size = vv,
		shape = 22
	)
}

# selected words

if ( (is.null(target_ids) == FALSE) ) {
	var_select <- target_ids

	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			fill = com_label[var_select]
		),
		show.legend = F,
		colour = NA,
		alpha = 0.8,
		size = vv * 2 / 3,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			fill = com_label[var_select]
		),
		show.legend = F,
		colour = gray_color_n,
		alpha = alpha_value,
		size = vv,
		shape = 22
	)
	
	p <- p + geom_point(
		data = data.frame(
			x = lay_f[var_select,1],
			y = lay_f[var_select,2]
		),
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y
		),
		fill = NA,
		show.legend = F,
		colour = gray_color_n,
		alpha = alpha_value,
		size = vv * 1.4,
		shape = 22
	)
}

#---------------#
#  Node labels  #

#if ( (use_freq_as_fontsize == 1) && (use_freq_as_size == 1) ) {
#	p <- p + geom_nodetext(
#		aes(label = lab, size=size * 0.1),
#		show.legend = F,
#		family="Meiryo UI",
#		fontface=face
#	)
#}

if (
	( com_method == "com-b" || com_method == "com-g" || com_method == "com-r" || com_method == "cor")
	&& gray_scale == 1
	&& smaller_nodes == 0
){
	p <- p + geom_label(
		data = lay_f_df,
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			label = lab
		),
		size=4 * font_size,
		hjust = hjust,
		nudge_x = nudge,
		nudge_y = nudge * 1.25,
		family=font_fam,
		na.rm = T,
		label.size = NA,
		label.padding = unit(0.2 * font_size, "lines"),
		label.r = unit(0.1, "lines"),
		fontface=face
	)
} else {
	p <- p + geom_text(
		data = lay_f_df,
		aes(
			x = x,
			y = y,
			xend = x,
			yend = y,
			label = lab
		),
		size=4 * font_size,
		hjust = hjust,
		nudge_x = nudge,
		nudge_y = nudge * 1.25,
		family=font_fam,
		na.rm = T,
		fontface=face
	)
}

#---------------#
#  Edge labels  #

if (view_coef == 1){
	my_n_form <- function(d){
		len = length(d)
		for (i in 1:len){
			s <- d[i]
			if ( is.na(s) || is.nan(s) || is.null(s) ){
				s <- NA
			} else {
				s <- as.numeric(s)
				if (s < 1){
					s <- sprintf("%.2f",s)
					s <- substring(s, 2, 4)
				} else {
					s <- sprintf("%.1f",s)
				}
			}
			d[i] <- s
		}
		return(d)
	}
	
	p <- p + geom_edgetext(
		aes(label = my_n_form(weight)),
		color = "#000080",
		fill = NA,
		size=3.5,
	)
}

#-------------------#
#  Community color  #

if ( com_method == "com-b" || com_method == "com-g" || com_method == "com-r"){
	if ( gray_scale == 1) {
		p <- p + scale_color_grey(
			na.value = "white",
			guide = FALSE
		)
		p <- p + scale_fill_grey(
			na.value = "white",
			guide = guide_legend(
				title = "Subgraph:",
				override.aes = list(size=5.5, alpha=1, shape=22),
				keyheight = unit(1,"line"),
				ncol=2,
				order = 1
			)
		)
	} else {
		if ( length(com_m$csize[com_m$csize > 1]) <= 12 ){
			p <- p + scale_color_brewer(
				palette = "Set3",
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_brewer(
				palette = "Set3",
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		} else if (length(com_m$csize[com_m$csize > 1]) <= 20)  {
			library(ggsci)
			c20org <- col2rgb( pal_d3("category20")(20) )

			p <- p + scale_color_manual(
				values = rgb( t( ( 255 - ( 255 - c20org ) * 0.5 ) / 255  ) ),
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_manual(
				values = rgb( t( ( 255 - ( 255 - c20org ) * 0.5 ) / 255  ) ),
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		} else {
			p <- p + scale_color_hue(
				c = 50,
				l = 85,
				na.value = "white",
				guide = FALSE
			)
			p <- p + scale_fill_hue(
				c = 50,
				l = 85,
				na.value = "white",
				guide = guide_legend(
					title = "Subgraph:",
					override.aes = list(size=5.5, alpha=1, shape=22, colour="gray45"),
					keyheight = unit(1.25,"line"),
					ncol=2,
					order = 1
				)
			)
		}
	}
}

#--------------------#
#  Centrality color  #

if ( com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e"){
	
	if (gray_scale == 1){
		myPalette <- gray( seq(1, 0.4, length.out=100) )
	} else {
		if (color_universal_design == 0){
			myPalette <- cm.colors(99)
		} else {
			library(RColorBrewer)
			col_seed <- brewer.pal(8,"YlGnBu")[1:6]

			myPalette <- colorRampPalette( col_seed )
			myPalette <- myPalette(99)
		}
	}

	p <- p + scale_color_gradientn(
		colours = myPalette,
		guide = FALSE
	)
	p <- p + scale_fill_gradientn(
		colours = myPalette,
		guide = guide_colourbar(
			title = "Centrality:\n",
			title.theme = element_text(
				family=sans,
				face="bold",
				size=11,
				lineheight=0.4,
				angle=0
			),
			order = 1,
			#override.aes = list(size=6, shape=22),
			label.hjust = 1,
			#reverse = TRUE,
			#ncol=2,
			#keyheight = unit(1.5,"line")
		)
	)
}

#----------------#
#  2 Mode color  #

if (com_method == "twomode_c"){
	p <- p + scale_color_manual(
		values = brewer.pal(8, "Spectral")[4:8],
		guide = FALSE
	)
	p <- p + scale_fill_manual(
		values = brewer.pal(8, "Spectral")[4:8],
		guide = guide_legend(
			title = "Degree:",
			order = 1,
			override.aes = list(size=5.5, shape=22, alpha=1),
			#label.hjust = "left",
			#reverse = TRUE,
			#ncol=2,
			keyheight = unit(1.2,"line")
		)
	)
}

if ( com_method == "none" || com_method == "twomode_g"){
	p <- p + scale_color_manual(
		values = c("white"),
		na.value = "white",
		guide = F
	)
	p <- p + scale_fill_manual(
		values = c("white"),
		na.value = "white",
		guide = F
	)
}

#---------------------#
#  Final adjustments  #

p <- p + theme_blank(
	base_family  = font_fam
)

if (com_method == "cor" && gray_scale == 0){ # cor
	if ( cor_var_darker == 1 ){
		col_backg <- "gray50"
	} else {
		col_backg <- "gray60"
	}
	p <- p + theme(
		panel.background = element_rect(fill = col_backg, colour = NA)
	)
}

p <- p + theme(
	legend.title    = element_text(family=sans, face="bold",  size=11, angle=0),
	legend.text     = element_text(face="plain", size=11, angle=0)
)


# make a small space between the graph and the legend
margin <- 0.04
extra  <- 0.025

m_t <- margin_top    / 100
m_b <- margin_bottom / 100
m_l <- margin_left   / 100
m_r <- margin_right  / 100

xlimv <- c(0-margin-extra-m_l, 1+margin+extra+m_r)
ylimv <- c(0-margin-m_b, 1+margin+m_t)

p <- p + coord_fixed(
	ratio = 1,
	expand = F,
	xlim = xlimv,
	ylim = ylimv
)

g <- ggplotGrob(p)

if ( length( g$grobs[[8]][[1]][[1]] ) > 1){
	if ( 
		(com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e")
		&& ( gray_scale == 0 )
	){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray45"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.25
	}
	if ( 
		(com_method == "cnt-b" || com_method == "cnt-d" || com_method == "cnt-e")
		&& ( gray_scale == 1 )
	){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray30"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.25
	}
	if ( com_method == "cor" && gray_scale == 0){
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$col <- "gray40"
		g$grobs[[8]][[1]][[1]]$grobs[[5]]$gp$lwd <- 1.1
	}
}

library(grid)
library(gtable)

# fixing width of legends to 22%
if ( exists("saving_file") ){
	if ( saving_file == 0){
		target_legend_width <- convertX(
			unit( image_width * 0.22, "in" ),
			"mm"
		)
		if ( as.numeric( substr( packageVersion("ggplot2"), 1, 3) ) <= 2.1 ){ # ggplot2 <= 2.1.0
			diff_mm <- diff( c(
				convertX( g$widths[5], "mm" ),
				target_legend_width
			))
			if ( diff_mm > 0 ){
				print(diff_mm)
				g <- gtable_add_cols(g, unit(diff_mm, "mm"))
			}
		} else { # ggplot2 >= 2.2.0
			
			diff_mm <- diff( c(
				convertX( g$widths[7], "mm", valueOnly=T ) + convertX( g$widths[8], "mm", valueOnly=T ),
				target_legend_width
			))
			if ( diff_mm > 0 ){
				print(diff_mm)
				g <- gtable_add_cols(g, unit(diff_mm, "mm"))
			}
		}
	}
}

grid.draw(g)

if (exists("com_m")){
	rm("com_m")
}
if (exists("ccol_raw")){
	rm("ccol_raw")
}
if (exists("edg_mst")){
	rm("edg_mst")
}
if (exists("edg_lty")){
  rm("edg_lty")
}
ccol <- igraph::get.vertex.attribute(n2,"com")
}

# edges: 100

# min. jaccard: 0.0761422296075762

# breaks: 25, 50, 75, 100
```


### **4. 階層的クラスター分析:小学生女児(図3と対応）**
```{r 階層的クラスター分析（小学生女児）}
d <- matrix( c(0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,1,0,0,0,0,1,0
,0,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,1,0,0
,1,1,1,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,1,0,1,1
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,1,0,0,0
,0,0,0,0,0,1,0,1,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,1,0,0,0,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,1,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,1,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,1,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,1,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,1,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,1,0,0,0,0,0,0,0
,1,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,1,0,0,0,1,1,0
,1,0,0,1,1,0,0,0,1,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,1
,0,1,0,0,0,0,0,0,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,0,1,0,0,0,0,1,0,0,0,0
,0,1,0,0,1,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,1,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,1,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,1,0
,1,1,0,0,0,1,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,1,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,1,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,1,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,1,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,1,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,1,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,1,1,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,1,0,1,0
,1,0,0,0,0,0,0,1,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,1,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,1,0,0,0,0,0,0
,0,0,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,1,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,1,0,1,0,0,0,1,0
,0,0,0,0,0,1,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,1,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,1,1,0
,1,1,0,0,0,0,0,1,0,0,0
,0,0,0,1,0,0,0,1,0,1,0
,0,0,0,1,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,1,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,1,0,1,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,1,0,0
,1,0,0,0,0,0,0,0,1,0,0
,1,0,0,0,0,0,0,0,0,0,0
), ncol=11, nrow=166, byrow=TRUE)
color_universal_design <- 1

# dpi: short based

d <- t(d)
row.names(d) <- c("\uff0a\u958b\u793a","\uff0a\u5b66\u6821\u9818\u57df","\uff0a\u533b\u7642\u9818\u57df","\uff0a\u5bb6\u5ead\uff08\u6bcd\uff09","\uff0a\u5bb6\u5ead\uff08\u7236\uff09","\uff0a\u77e5\u4eba","\uff0a\u4fdd\u80b2\u5712","\uff0a\u5e02\u3068\u65bd\u8a2d\u95a2\u9023","\uff0a\u8b66\u5bdf","\uff0a\u60c5\u5831\u5171\u6709","\uff0a\u7591\u3044")
d <- subset(d, rowSums(d) > 0)
# END: DATA
n_cls <- 3
font_size <- 1
labels <- rownames(d)
rownames(d) <- NULL
freq <- NULL
for (i in 1:nrow(d)) {
	freq[i] = sum( d[i,] )
}
method_dist <- "binary"
method_clst <- "ward"

library(amap)
dj <- Dist(d,method=method_dist)

if (
	   ( as.numeric( R.Version()$major ) >= 3 )
	&& ( as.numeric( R.Version()$minor ) >= 1.0)
){                                                      # >= R 3.1.0
	if (method_clst == "ward"){
		method_clst  <-  "ward.D2"
	}
	hcl <- hclust(dj,method=method_clst)
} else {                                                # <= R 3.0
	if (method_clst == "ward"){
		dj <- dj^2
		hcl <- hclust(dj,method=method_clst)
		hcl$height <- sqrt( hcl$height )
	} else {
		hcl <- hclust(dj,method=method_clst)
	}
}
par(
			mai=c(0,0,0,0),
			mar=c(1,2,1,0),
			omi=c(0,0,0,0),
			oma=c(0,0,0,0) 
		)


library(grid)
library(ggplot2)
library(ggdendro)

ddata <- dendro_data(as.dendrogram(hcl), type="rectangle")

p <- NULL
p <- ggplot()

font_family <- "Meiryo UI"
if ( exists("PERL_font_family") ){
	font_family <- PERL_font_family
}

# \u30af\u30e9\u30b9\u30bf\u30fc\u3054\u3068\u306e\u30ab\u30e9\u30fc\u8a2d\u5b9a

if (n_cls > 1){
	memb <- cutree(hcl,k=n_cls)
	# \u5168\u4f53\u306e\u8272\u8a2d\u5b9a
	p <- p + scale_colour_hue(l=40, c=100)
	# \u5207\u308a\u96e2\u3057\u7dda(1)
	cutpoint <- mean(
		c(
			rev(hcl$height)[n_cls-1],
			rev(hcl$height)[n_cls]
		)
	)
	# \u8272\u306e\u9806\u756a\u3092\u6c7a\u5b9a
	n <- length( unique(memb[hcl$order]) )
	new_col <- NULL
	for (i in 1:ceiling(n / 2) ){
		new_col <- c(new_col, i)
		if (i + ceiling(n / 2) <= n){
			new_col <- c(new_col, i + ceiling(n / 2))
		}
	}
	# \u30af\u30e9\u30b9\u30bf\u30fc\u756a\u53f7\u2192\u8272\u540d\u306e\u5909\u63db\u7528\u30d9\u30af\u30c8\u30eb\u4f5c\u6210\uff08col_vec\uff09
	col_tab <- cbind(
		unique(memb[hcl$order]),
		new_col
	)
	colnames(col_tab) <- c("org","new")
	col_vec <- NULL
	for (i in col_tab[order(col_tab[,1]),2]){
		c <- as.character(i)
		while (nchar(c) < 3){
			c <- paste("0",c,sep="")
		}
		col_vec <- c(col_vec, c)
	}
	# \u7dda\u306e\u8272\u5206\u3051
	seg_bl <- NULL
	seg_cl <- NULL
	colnames(ddata$segment) <- c(
		"x0",
		"y0",
		"x1",
		"y1"
	)
	colnames(ddata$labels) <- c(
		"x",
		"y",
		"text"
	)
	for ( i in 1:nrow( ddata$segment ) ) {
		if (
			   ddata$segment$y0[i] > cutpoint
			|| ddata$segment$y1[i] > cutpoint
			|| (
				   ddata$segment$y0[i] >= cutpoint
				&& ddata$segment$y1[i] >= cutpoint
			   )
		) {
			seg_bl <- c(
				seg_bl,
				ddata$segment$x0[i],
				ddata$segment$y0[i],
				ddata$segment$x1[i],
				ddata$segment$y1[i]
			)
		} else {
			seg_cl <- c(
				seg_cl,
				ddata$segment$x0[i],
				ddata$segment$y0[i],
				ddata$segment$x1[i],
				ddata$segment$y1[i],
				#col_vec[
					memb[hcl$order][
						floor(
							mean(
								ddata$segment$x0[i],
								ddata$segment$x1[i]) 
							)
					]
				#]
			)
		}
	}
	seg_bl = matrix(seg_bl, byrow=T, ncol=4 )
	seg_cl = matrix(seg_cl, byrow=T, ncol=5 )
	
	if (is.null(seg_bl) == F){
		colnames(seg_bl) <- c("x0", "y0", "x1", "y1")
		seg_bl <- as.data.frame(seg_bl)
		# \u5207\u308a\u96e2\u3057\u7dda(2)
		if ( max(seg_bl$y1) > cutpoint ){
			p <- p + geom_hline(
				yintercept = cutpoint,
				colour="black",
				linetype=5,
				size=0.5
			)
		}
	}
	colnames(seg_cl) <- c("x0", "y0", "x1", "y1", "c")
	seg_cl <- as.data.frame(seg_cl)
	seg_cl$c <- col_vec[seg_cl$c]

	p <- p + geom_text(
		data=data.frame(                    # \u30e9\u30d9\u30eb
			x=label(ddata)$x,
			y=label(ddata)$y,
			text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
		),
		aes_string(
			x="x",
			y="y",
			label="text",
			colour="cols"
		),
		hjust=1,
		angle =0,
		family = font_family,
		fontface = "bold",
		size = 5 * 0.85 * font_size
	)

	p <- p + geom_segment(
		data=seg_cl,
		aes_string(x="x0", y="y0", xend="x1", yend="y1", colour="c"),
		size=0.5
	)
} else {
	memb <- rep( c("a"), length(labels) )
	p <- p + scale_colour_manual(values=c("black"))
	seg_bl <- ddata$segment
	col_vec <- c("001")
	p <- p + geom_text(
		data=data.frame(                    # \u30e9\u30d9\u30eb
			x=label(ddata)$x,
			y=label(ddata)$y,
			text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
		),
		aes_string(
			x="x",
			y="y",
			label="text",
			colour="cols"
		),
		hjust=1,
		angle =0,
		family = font_family,
		fontface = "bold",
		size = 5 * 0.85 * font_size
	)
}

if (is.null(seg_bl) == F){
	p <- p + geom_segment(
		data=seg_bl,
		aes_string(x="x0", y="y0", xend="x1", yend="y1"),
		color="gray50",
		linetype=1,
	)
}

p <- p + geom_text(
	data=data.frame(                    # \u30e9\u30d9\u30eb\u5909\u63db
		x=label(ddata)$x,
		y=label(ddata)$y,
		text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
		cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
	),
	aes_string(
		x="x",
		y="y",
		label="text",
		colour="cols"
	),
	hjust=1,
	angle =0,
	family = font_family,
	fontface = "bold",
	size = 5 * 0.85 * font_size
)

# \u8a9e\u3084\u30b3\u30fc\u30c9\u306e\u9577\u3055\u306b\u3042\u308f\u305b\u3066\u4f59\u767d\u306e\u5927\u304d\u3055\u3092\u8a2d\u5b9a
y_max <- max( ddata$segment$y1 )
y_min <- 0.2
# "strwidth" crashes if the device is cairo_pdf or cairo_ps 
if (
	is.na(dev.list()["cairo_pdf"])
	&& is.na(dev.list()["cairo_ps"])
){
	y_min <- max(
		strwidth(
			labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			units = "figure",
			font = 2
		)
	)
}
y_min <- y_min * font_size
y_min <- ( 6 * y_max * y_min ) / ( 5 - 6 * y_min )
y_min <- y_min * 1.1
if (y_min > y_max * 2){
	y_min <- y_max * 2
}
y_min <- y_min * -1

# \u76ee\u76db\u306e\u4f4d\u7f6e\u3092\u8a2d\u5b9a
b1 <- 0
for (i in 1:1000){
	b1 <- signif(y_max * 0.875, i)
	if (b1 < y_max){
		break
	}
}

p <- p + coord_flip()
p <- p + scale_x_reverse(
	expand = c(0,0),
	breaks = NULL,
	limits=c( length(ddata$labels$text) + 0.5 , 1 - 0.5 )
)
p <- p + scale_y_continuous(
	limits=c(y_min,y_max),
	breaks=c(0,b1/2,b1),
	expand = c(0.02,0.02)
)

p <- p + theme(
	axis.title.y = element_blank(),
	axis.title.x = element_blank(),
	axis.ticks   = element_line(colour="gray60"),
	axis.text.y  = element_text(size=12,colour="gray40"),
	axis.text.x  = element_text(size=12,colour="gray40"),
	legend.position="none"
)

if (n_cls <= 1){
	p <- p + theme(
		axis.text.y  = element_blank(),
		axis.text.x  = element_text(size=12,colour="black"),
		axis.ticks = element_line(colour="black"),
		#panel.grid.major = theme_blank(),
		#panel.grid.minor = theme_blank(),
		#panel.background = theme_blank(),
		axis.line = element_line(colour = "black")
	)
}

show_bar <- 1

if (show_bar == 1){
	p <- p + theme(
		axis.ticks  = element_blank(),
		axis.text.y = element_blank()
	)
	p <- p + theme(
		plot.margin = unit(c(0,0,0,0), "lines")
	)

	bard <- data.frame(
		nm <- labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
		ht <- freq[ as.numeric( as.vector( ddata$labels$text ) ) ],
		cl <- col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ],
		od <- nrow(d):1
	)

	if (n_cls <= 1){
		bard$cl <- "001"
	}

	p2 <- NULL
	p2 <- ggplot()
	p2 <- p2 + geom_bar(
		stat="identity",
		position = "identity",
		width=0.75,
		data=bard,
		aes(
			x=reorder(od,od),
			y=ht,
			fill=cl
		)
	)
	p2 <- p2 + coord_flip()
	p2 <- p2 + scale_y_reverse( expand = c(0,0))
	p2 <- p2 + scale_x_discrete( expand = c(0,0) )
	p2 <- p2 + theme(
		axis.title.y     = element_blank(),
		axis.title.x     = element_blank(),
		axis.ticks       = element_blank(),
		axis.text.y      = element_blank(),
		axis.text.x      = element_text(size=12,colour="white"),
		legend.position  = "none",
		panel.background = element_rect(fill="white", colour="white"),
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank()
	)

	margin <- 0.002 * nrow(d) + 0.00001 * nrow(d)^2 - 0.12
	p2 <- p2 + theme(
		plot.margin = unit(c(0.25,0,0.25,0), "lines") # r: -0.75
	)

	grid.newpage()
	pushViewport(viewport(layout=grid.layout(1,2, width=c(1,5)) ) )
	print(p,  vp= viewport(layout.pos.row=1, layout.pos.col=2) )
	print(p2, vp= viewport(layout.pos.row=1, layout.pos.col=1) )
} else {
	print(p)
}

if (
	is.na(dev.list()["pdf"])
	&& is.na(dev.list()["postscript"])
	&& is.na(dev.list()["cairo_pdf"])
	&& is.na(dev.list()["cairo_ps"])
){
	if ( grepl("darwin", R.version$platform) ){
		quartzFonts(HiraKaku=quartzFont(rep("Meiryo UI",4)))
		grid.force()
		grid.gedit("GRID.text", grep=TRUE, global=TRUE, gp=gpar(fontfamily="HiraKaku"))
	}
}

detach("package:ggdendro", unload=T)

# for clickable image map
exp <- (y_max - y_min ) * 0.02
coord <- cbind(
	(1 / 6 + 5 / 6 * -1 * (y_min - exp) / ( (y_max + exp) - (y_min - exp) )) * 1.03,
	1:length(ddata$labels$text) / length(ddata$labels$text)
)
rownames(coord) <-
	labels[ as.numeric( as.vector( ddata$labels$text ) ) ]



```
### **5. 階層的クラスター分析:中学生女児(図4と対応）**
```{r 階層的クラスター分析（中学生女児）}
d <- matrix( c(0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,1,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,1,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,1,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,1
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,1,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,1,0,0
,1,0,0,0,0,1,0,0,0,1,0
,1,1,0,0,0,0,0,1,0,0,0
,1,0,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,1,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,1,0,0,0,1,0
,0,0,0,0,0,0,0,0,1,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,1,0,0,0,1,1,0
,0,0,0,0,0,0,0,0,1,0,0
,1,0,0,0,0,1,0,0,1,1,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,1,0,0,0,1,0
,0,0,0,0,0,0,0,0,1,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,1,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,1,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,1,0,0,0,0,0,0,0
,1,0,1,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,1,0
,1,0,1,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,1,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,1,0,0,0,0,0
,0,0,0,0,1,0,0,0,0,0,0
,0,0,0,0,1,0,0,0,0,0,0
,1,1,0,0,0,0,0,1,0,1,0
,0,0,0,0,0,1,0,0,0,1,0
,0,0,0,0,0,0,0,0,1,1,0
,1,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,1,1,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,1,0
,1,0,0,1,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,1,1,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,1,0,0
,0,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,1,0,0,0
,0,0,0,0,1,0,0,0,1,0,0
,0,0,0,0,0,1,0,0,1,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,1,0
,0,1,0,1,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,1,0,0,0,0,0,0,0,0
,1,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,1,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,1,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,1,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,1,0
,1,0,0,0,0,0,0,1,0,1,0
,0,0,0,1,0,0,0,0,1,1,0
,0,1,0,1,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,1,0,0,0,0,1,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,0,1,0,0,0,0,0,0,0,1,0
,0,0,0,1,0,0,0,0,0,0,0
,1,1,0,0,0,0,0,0,1,1,0
,0,1,0,1,0,0,0,0,0,1,1
,1,0,0,1,0,0,0,0,0,0,0
,0,1,0,0,0,0,0,0,0,0,0
,0,0,1,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,1,1,1,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,0,0
,0,0,0,0,0,0,0,0,0,1,0
,0,0,0,0,0,0,0,0,0,0,0
,1,1,0,0,0,1,0,0,0,0,0
,1,1,0,0,0,1,0,0,0,0,0
), ncol=11, nrow=189, byrow=TRUE)
color_universal_design <- 1

# dpi: short based

d <- t(d)
row.names(d) <- c("\uff0a\u958b\u793a","\uff0a\u5b66\u6821\u9818\u57df","\uff0a\u533b\u7642\u9818\u57df","\uff0a\u5bb6\u5ead\uff08\u6bcd\uff09","\uff0a\u5bb6\u5ead\uff08\u7236\uff09","\uff0a\u77e5\u4eba","\uff0a\u4fdd\u80b2\u5712","\uff0a\u5e02\u3068\u65bd\u8a2d\u95a2\u9023","\uff0a\u8b66\u5bdf","\uff0a\u60c5\u5831\u5171\u6709","\uff0a\u7591\u3044")
d <- subset(d, rowSums(d) > 0)
# END: DATA
n_cls <- 3
font_size <- 1
labels <- rownames(d)
rownames(d) <- NULL
freq <- NULL
for (i in 1:nrow(d)) {
	freq[i] = sum( d[i,] )
}
method_dist <- "binary"
method_clst <- "ward"

library(amap)
dj <- Dist(d,method=method_dist)

if (
	   ( as.numeric( R.Version()$major ) >= 3 )
	&& ( as.numeric( R.Version()$minor ) >= 1.0)
){                                                      # >= R 3.1.0
	if (method_clst == "ward"){
		method_clst  <-  "ward.D2"
	}
	hcl <- hclust(dj,method=method_clst)
} else {                                                # <= R 3.0
	if (method_clst == "ward"){
		dj <- dj^2
		hcl <- hclust(dj,method=method_clst)
		hcl$height <- sqrt( hcl$height )
	} else {
		hcl <- hclust(dj,method=method_clst)
	}
}
par(
			mai=c(0,0,0,0),
			mar=c(1,2,1,0),
			omi=c(0,0,0,0),
			oma=c(0,0,0,0) 
		)


library(grid)
library(ggplot2)
library(ggdendro)

ddata <- dendro_data(as.dendrogram(hcl), type="rectangle")

p <- NULL
p <- ggplot()

font_family <- "Meiryo UI"
if ( exists("PERL_font_family") ){
	font_family <- PERL_font_family
}

# \u30af\u30e9\u30b9\u30bf\u30fc\u3054\u3068\u306e\u30ab\u30e9\u30fc\u8a2d\u5b9a

if (n_cls > 1){
	memb <- cutree(hcl,k=n_cls)
	# \u5168\u4f53\u306e\u8272\u8a2d\u5b9a
	p <- p + scale_colour_hue(l=40, c=100)
	# \u5207\u308a\u96e2\u3057\u7dda(1)
	cutpoint <- mean(
		c(
			rev(hcl$height)[n_cls-1],
			rev(hcl$height)[n_cls]
		)
	)
	# \u8272\u306e\u9806\u756a\u3092\u6c7a\u5b9a
	n <- length( unique(memb[hcl$order]) )
	new_col <- NULL
	for (i in 1:ceiling(n / 2) ){
		new_col <- c(new_col, i)
		if (i + ceiling(n / 2) <= n){
			new_col <- c(new_col, i + ceiling(n / 2))
		}
	}
	# \u30af\u30e9\u30b9\u30bf\u30fc\u756a\u53f7\u2192\u8272\u540d\u306e\u5909\u63db\u7528\u30d9\u30af\u30c8\u30eb\u4f5c\u6210\uff08col_vec\uff09
	col_tab <- cbind(
		unique(memb[hcl$order]),
		new_col
	)
	colnames(col_tab) <- c("org","new")
	col_vec <- NULL
	for (i in col_tab[order(col_tab[,1]),2]){
		c <- as.character(i)
		while (nchar(c) < 3){
			c <- paste("0",c,sep="")
		}
		col_vec <- c(col_vec, c)
	}
	# \u7dda\u306e\u8272\u5206\u3051
	seg_bl <- NULL
	seg_cl <- NULL
	colnames(ddata$segment) <- c(
		"x0",
		"y0",
		"x1",
		"y1"
	)
	colnames(ddata$labels) <- c(
		"x",
		"y",
		"text"
	)
	for ( i in 1:nrow( ddata$segment ) ) {
		if (
			   ddata$segment$y0[i] > cutpoint
			|| ddata$segment$y1[i] > cutpoint
			|| (
				   ddata$segment$y0[i] >= cutpoint
				&& ddata$segment$y1[i] >= cutpoint
			   )
		) {
			seg_bl <- c(
				seg_bl,
				ddata$segment$x0[i],
				ddata$segment$y0[i],
				ddata$segment$x1[i],
				ddata$segment$y1[i]
			)
		} else {
			seg_cl <- c(
				seg_cl,
				ddata$segment$x0[i],
				ddata$segment$y0[i],
				ddata$segment$x1[i],
				ddata$segment$y1[i],
				#col_vec[
					memb[hcl$order][
						floor(
							mean(
								ddata$segment$x0[i],
								ddata$segment$x1[i]) 
							)
					]
				#]
			)
		}
	}
	seg_bl = matrix(seg_bl, byrow=T, ncol=4 )
	seg_cl = matrix(seg_cl, byrow=T, ncol=5 )
	
	if (is.null(seg_bl) == F){
		colnames(seg_bl) <- c("x0", "y0", "x1", "y1")
		seg_bl <- as.data.frame(seg_bl)
		# \u5207\u308a\u96e2\u3057\u7dda(2)
		if ( max(seg_bl$y1) > cutpoint ){
			p <- p + geom_hline(
				yintercept = cutpoint,
				colour="black",
				linetype=5,
				size=0.5
			)
		}
	}
	colnames(seg_cl) <- c("x0", "y0", "x1", "y1", "c")
	seg_cl <- as.data.frame(seg_cl)
	seg_cl$c <- col_vec[seg_cl$c]

	p <- p + geom_text(
		data=data.frame(                    # \u30e9\u30d9\u30eb
			x=label(ddata)$x,
			y=label(ddata)$y,
			text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
		),
		aes_string(
			x="x",
			y="y",
			label="text",
			colour="cols"
		),
		hjust=1,
		angle =0,
		family = font_family,
		fontface = "bold",
		size = 5 * 0.85 * font_size
	)

	p <- p + geom_segment(
		data=seg_cl,
		aes_string(x="x0", y="y0", xend="x1", yend="y1", colour="c"),
		size=0.5
	)
} else {
	memb <- rep( c("a"), length(labels) )
	p <- p + scale_colour_manual(values=c("black"))
	seg_bl <- ddata$segment
	col_vec <- c("001")
	p <- p + geom_text(
		data=data.frame(                    # \u30e9\u30d9\u30eb
			x=label(ddata)$x,
			y=label(ddata)$y,
			text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
		),
		aes_string(
			x="x",
			y="y",
			label="text",
			colour="cols"
		),
		hjust=1,
		angle =0,
		family = font_family,
		fontface = "bold",
		size = 5 * 0.85 * font_size
	)
}

if (is.null(seg_bl) == F){
	p <- p + geom_segment(
		data=seg_bl,
		aes_string(x="x0", y="y0", xend="x1", yend="y1"),
		color="gray50",
		linetype=1,
	)
}

p <- p + geom_text(
	data=data.frame(                    # \u30e9\u30d9\u30eb\u5909\u63db
		x=label(ddata)$x,
		y=label(ddata)$y,
		text=labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
		cols= col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ]
	),
	aes_string(
		x="x",
		y="y",
		label="text",
		colour="cols"
	),
	hjust=1,
	angle =0,
	family = font_family,
	fontface = "bold",
	size = 5 * 0.85 * font_size
)

# \u8a9e\u3084\u30b3\u30fc\u30c9\u306e\u9577\u3055\u306b\u3042\u308f\u305b\u3066\u4f59\u767d\u306e\u5927\u304d\u3055\u3092\u8a2d\u5b9a
y_max <- max( ddata$segment$y1 )
y_min <- 0.2
# "strwidth" crashes if the device is cairo_pdf or cairo_ps 
if (
	is.na(dev.list()["cairo_pdf"])
	&& is.na(dev.list()["cairo_ps"])
){
	y_min <- max(
		strwidth(
			labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
			units = "figure",
			font = 2
		)
	)
}
y_min <- y_min * font_size
y_min <- ( 6 * y_max * y_min ) / ( 5 - 6 * y_min )
y_min <- y_min * 1.1
if (y_min > y_max * 2){
	y_min <- y_max * 2
}
y_min <- y_min * -1

# \u76ee\u76db\u306e\u4f4d\u7f6e\u3092\u8a2d\u5b9a
b1 <- 0
for (i in 1:1000){
	b1 <- signif(y_max * 0.875, i)
	if (b1 < y_max){
		break
	}
}

p <- p + coord_flip()
p <- p + scale_x_reverse(
	expand = c(0,0),
	breaks = NULL,
	limits=c( length(ddata$labels$text) + 0.5 , 1 - 0.5 )
)
p <- p + scale_y_continuous(
	limits=c(y_min,y_max),
	breaks=c(0,b1/2,b1),
	expand = c(0.02,0.02)
)

p <- p + theme(
	axis.title.y = element_blank(),
	axis.title.x = element_blank(),
	axis.ticks   = element_line(colour="gray60"),
	axis.text.y  = element_text(size=12,colour="gray40"),
	axis.text.x  = element_text(size=12,colour="gray40"),
	legend.position="none"
)

if (n_cls <= 1){
	p <- p + theme(
		axis.text.y  = element_blank(),
		axis.text.x  = element_text(size=12,colour="black"),
		axis.ticks = element_line(colour="black"),
		#panel.grid.major = theme_blank(),
		#panel.grid.minor = theme_blank(),
		#panel.background = theme_blank(),
		axis.line = element_line(colour = "black")
	)
}

show_bar <- 1

if (show_bar == 1){
	p <- p + theme(
		axis.ticks  = element_blank(),
		axis.text.y = element_blank()
	)
	p <- p + theme(
		plot.margin = unit(c(0,0,0,0), "lines")
	)

	bard <- data.frame(
		nm <- labels[ as.numeric( as.vector( ddata$labels$text ) ) ],
		ht <- freq[ as.numeric( as.vector( ddata$labels$text ) ) ],
		cl <- col_vec[ memb[ as.numeric( as.vector( ddata$labels$text ) ) ] ],
		od <- nrow(d):1
	)

	if (n_cls <= 1){
		bard$cl <- "001"
	}

	p2 <- NULL
	p2 <- ggplot()
	p2 <- p2 + geom_bar(
		stat="identity",
		position = "identity",
		width=0.75,
		data=bard,
		aes(
			x=reorder(od,od),
			y=ht,
			fill=cl
		)
	)
	p2 <- p2 + coord_flip()
	p2 <- p2 + scale_y_reverse( expand = c(0,0))
	p2 <- p2 + scale_x_discrete( expand = c(0,0) )
	p2 <- p2 + theme(
		axis.title.y     = element_blank(),
		axis.title.x     = element_blank(),
		axis.ticks       = element_blank(),
		axis.text.y      = element_blank(),
		axis.text.x      = element_text(size=12,colour="white"),
		legend.position  = "none",
		panel.background = element_rect(fill="white", colour="white"),
		panel.grid.major = element_blank(),
		panel.grid.minor = element_blank()
	)

	margin <- 0.002 * nrow(d) + 0.00001 * nrow(d)^2 - 0.12
	p2 <- p2 + theme(
		plot.margin = unit(c(0.25,0,0.25,0), "lines") # r: -0.75
	)

	grid.newpage()
	pushViewport(viewport(layout=grid.layout(1,2, width=c(1,5)) ) )
	print(p,  vp= viewport(layout.pos.row=1, layout.pos.col=2) )
	print(p2, vp= viewport(layout.pos.row=1, layout.pos.col=1) )
} else {
	print(p)
}

if (
	is.na(dev.list()["pdf"])
	&& is.na(dev.list()["postscript"])
	&& is.na(dev.list()["cairo_pdf"])
	&& is.na(dev.list()["cairo_ps"])
){
	if ( grepl("darwin", R.version$platform) ){
		quartzFonts(HiraKaku=quartzFont(rep("Meiryo UI",4)))
		grid.force()
		grid.gedit("GRID.text", grep=TRUE, global=TRUE, gp=gpar(fontfamily="HiraKaku"))
	}
}

detach("package:ggdendro", unload=T)

# for clickable image map
exp <- (y_max - y_min ) * 0.02
coord <- cbind(
	(1 / 6 + 5 / 6 * -1 * (y_min - exp) / ( (y_max + exp) - (y_min - exp) )) * 1.03,
	1:length(ddata$labels$text) / length(ddata$labels$text)
)
rownames(coord) <-
	labels[ as.numeric( as.vector( ddata$labels$text ) ) ]





```


```{r cars}
```
